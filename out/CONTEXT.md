# Project Snapshot (Django)

- Root: `C:\Users\riki_\Documents\GitHub\NINVENDO-django-classified-demo`
- Generated by: `snapshot_django.py`
- Templates mode: `interesting`

---

## Project Tree (compact)

```
NINVENDO-django-classified-demo/
â”œâ”€â”€ demo/
â”‚   â”œâ”€â”€ craigslist_data/
â”‚   â”‚   â”œâ”€â”€ Areas.json
â”‚   â”‚   â”œâ”€â”€ Categories.json
â”‚   â”‚   â””â”€â”€ Types.json
â”‚   â”œâ”€â”€ management/
â”‚   â”‚   â””â”€â”€ commands/
â”‚   â”‚       â””â”€â”€ setup_project.py
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â””â”€â”€ demo/
â”‚   â”‚       â””â”€â”€ login.html
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ tests.py
â”œâ”€â”€ out/
â”‚   â”œâ”€â”€ CONTEXT.md
â”‚   â””â”€â”€ GIT_HISTORY.txt
â”œâ”€â”€ payments/
â”‚   â”œâ”€â”€ templatetags/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ payments_tag.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ admin.py
â”‚   â”œâ”€â”€ apps.py
â”‚   â”œâ”€â”€ context_processor.py
â”‚   â”œâ”€â”€ forms.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ signals.py
â”‚   â”œâ”€â”€ urls.py
â”‚   â””â”€â”€ views.py
â”œâ”€â”€ project/
â”‚   â”œâ”€â”€ templatetags/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ site_tags.py
â”‚   â”œâ”€â”€ context_processors.py
â”‚   â”œâ”€â”€ settings.py
â”‚   â””â”€â”€ urls.py
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ django_classified/
â”‚   â”‚   â”œâ”€â”€ _base.html
â”‚   â”‚   â”œâ”€â”€ item_detail.html
â”‚   â”‚   â”œâ”€â”€ item_form.html
â”‚   â”‚   â”œâ”€â”€ item_list.html
â”‚   â”‚   â”œâ”€â”€ login.html
â”‚   â”‚   â”œâ”€â”€ password_reset_complete.html
â”‚   â”‚   â”œâ”€â”€ password_reset_confirm.html
â”‚   â”‚   â”œâ”€â”€ password_reset_done.html
â”‚   â”‚   â”œâ”€â”€ password_reset_email.txt
â”‚   â”‚   â”œâ”€â”€ password_reset_form.html
â”‚   â”‚   â”œâ”€â”€ password_reset_subject.txt
â”‚   â”‚   â”œâ”€â”€ profile.html
â”‚   â”‚   â”œâ”€â”€ search.html
â”‚   â”‚   â””â”€â”€ section_list.html
â”‚   â”œâ”€â”€ payments/
â”‚   â”‚   â”œâ”€â”€ payment.success.html
â”‚   â”‚   â”œâ”€â”€ purchase_history.html
â”‚   â”‚   â”œâ”€â”€ request_detail.html
â”‚   â”‚   â”œâ”€â”€ request_purchase.html
â”‚   â”‚   â”œâ”€â”€ sales_history.html
â”‚   â”‚   â”œâ”€â”€ seller_requests.html
â”‚   â”‚   â”œâ”€â”€ seller_setup.html
â”‚   â”‚   â”œâ”€â”€ template_seller_setup.html
â”‚   â”‚   â””â”€â”€ transaction_detail.html
â”‚   â”œâ”€â”€ registration/
â”‚   â”‚   â”œâ”€â”€ registration_complete.html
â”‚   â”‚   â””â”€â”€ registration_form.html
â”‚   â”œâ”€â”€ trade/
â”‚   â”‚   â”œâ”€â”€ detail.html
â”‚   â”‚   â”œâ”€â”€ inbox.html
â”‚   â”‚   â”œâ”€â”€ propose.html
â”‚   â”‚   â”œâ”€â”€ sent.html
â”‚   â”‚   â””â”€â”€ user_profile.html
â”‚   â””â”€â”€ base.html
â”œâ”€â”€ trade/
â”‚   â”œâ”€â”€ management/
â”‚   â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ mangement/
â”‚   â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ create_user_profiles.py
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ admin.py
â”‚   â”œâ”€â”€ apps.py
â”‚   â”œâ”€â”€ forms.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ tests.py
â”‚   â”œâ”€â”€ urls.py
â”‚   â”œâ”€â”€ user_profile.py
â”‚   â””â”€â”€ views.py
â”œâ”€â”€ __init__.py
â”œâ”€â”€ app.json
â”œâ”€â”€ baratto.ps1
â”œâ”€â”€ customize_templates.py
â”œâ”€â”€ db.sqlite3
â”œâ”€â”€ fix_templates.py
â”œâ”€â”€ LICENSE
â”œâ”€â”€ list_html.txt
â”œâ”€â”€ list_py.txt
â”œâ”€â”€ manage.py
â”œâ”€â”€ Procfile
â”œâ”€â”€ proj_snapshot.py
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ runtime.txt
â”œâ”€â”€ setup_site.py
â””â”€â”€ wsgi.py
```


---

## Git History (last 50 commits)

```
afaea22 | 2025-09-03 | riccardo74 | Add payments app and integrate barter system
01abd74 | 2025-09-02 | riccardo74 | Merge branch 'baratto' into master
fdf3425 | 2025-09-02 | riccardo74 | Add media URL serving in DEBUG mode
2b09447 | 2025-09-02 | riccardo74 | Aggiungi supporto immagini alla messaggistica degli scambi
c1af384 | 2025-09-01 | riccardo74 | Refactor TradeProposal state management to use CharField
1adefaf | 2025-09-01 | riccardo74 | Add project snapshot and trade module integration
1c788d0 | 2025-08-31 | riccardo74 | Move registration templates and add base.html bridge
eff7548 | 2025-08-31 | riccardo74 | Add trade (barter) module with user proposals
1f7483b | 2025-08-31 | riccardo74 | Add NINVENDO branding and dynamic site config support
eea7fe8 | 2025-08-31 | riccardo74 | Add list_html.txt and list_py.txt files
a484832 | 2025-08-31 | riccardo74 | Set local memory cache backend for development
48bd3b2 | 2025-04-03 | dependabot[bot] | Bump django from 5.1.7 to 5.1.8 (#173)
11cf76a | 2025-03-11 | dependabot[bot] | Bump django from 5.1.5 to 5.1.7 (#172)
6f541c1 | 2025-01-26 | dependabot[bot] | Bump django from 5.1.4 to 5.1.5 (#168)
ed34e86 | 2025-01-06 | Sergey Lyapustin | Update deployment template to use repo_clone_url instead of github
1d50510 | 2025-01-05 | Sergey Lyapustin | Digital Ocean deployment button (#166)
3187eb1 | 2025-01-05 | Sergey Lyapustin | Update project configuration and dependencies
36aba25 | 2023-07-25 | Sergey Lyapustin | Merge pull request #163 from slyapustin/dependabot/pip/django-3.2.18
7c01deb | 2023-07-25 | Sergey Lyapustin | Merge pull request #164 from slyapustin/dokku
859b9ec | 2023-07-25 | Sergey Lyapustin | Set DEFAULT_AUTO_FIELD config option.
56f95cd | 2023-07-25 | Sergey Lyapustin | Updated Python version.
d8cc25f | 2023-02-15 | dependabot[bot] | Bump django from 3.2.15 to 3.2.18
3c799bf | 2022-08-11 | Sergey Lyapustin | Merge pull request #159 from slyapustin/dependabot/pip/django-3.2.15
251e0e3 | 2022-08-11 | dependabot[bot] | Bump django from 3.2.14 to 3.2.15
b9de3ef | 2022-07-17 | Sergey Lyapustin | Updated Python
c74a3a1 | 2022-07-17 | Sergey Lyapustin | Merge branch 'master' of github.com:inoks/django-classified-demo
d3f2eb3 | 2022-07-17 | Sergey Lyapustin | Updated Packages.
0c49ac9 | 2022-05-07 | Sergey Lyapustin | Merge pull request #158 from slyapustin/dependabot/pip/django-3.1.14
965588c | 2022-05-07 | dependabot[bot] | Bump django from 3.1.13 to 3.1.14
5d17ec8 | 2022-05-07 | Sergey Lyapustin | Merge pull request #145 from slyapustin/dependabot/pip/django-3.1.13
3769a97 | 2021-09-22 | dependabot[bot] | Bump django from 3.0.9 to 3.1.13
6f5633d | 2020-12-23 | Sergey Lyapustin | Merge pull request #109 from slyapustin/pyup-update-whitenoise-5.1.0-to-5.2.0
1440971 | 2020-12-23 | Sergey Lyapustin | Merge pull request #112 from slyapustin/pyup-update-psycopg2-binary-2.8.5-to-2.8.6
3841296 | 2020-12-23 | Sergey Lyapustin | Merge pull request #114 from praveenmylavarapu/master
1a291c5 | 2020-12-17 | Sergey Lyapustin | Merge pull request #118 from slyapustin/pyup-update-django-storages-1.9.1-to-1.11
0f34723 | 2020-12-17 | pyup-bot | Update django-storages from 1.9.1 to 1.11
50e6a40 | 2020-10-01 | Praveen Mylavarapu | Read .env file
2132003 | 2020-09-07 | pyup-bot | Update psycopg2-binary from 2.8.5 to 2.8.6
c8d73c9 | 2020-08-04 | pyup-bot | Update whitenoise from 5.1.0 to 5.2.0
fa4bd1d | 2020-08-04 | Sergey Lyapustin | Merge pull request #107 from slyapustin/pyup-update-django-3.0.7-to-3.0.9
72d7097 | 2020-08-03 | pyup-bot | Update django from 3.0.7 to 3.0.9
32a72b2 | 2020-06-04 | Sergey Lyapustin | Merge pull request #104 from slyapustin/pyup-update-django-3.0.6-to-3.0.7
58b54dd | 2020-06-03 | pyup-bot | Update django from 3.0.6 to 3.0.7
6ec458d | 2020-05-21 | Sergey Lyapustin | Merge pull request #102 from slyapustin/pyup-update-whitenoise-5.0.1-to-5.1.0
2614398 | 2020-05-20 | pyup-bot | Update whitenoise from 5.0.1 to 5.1.0
81ccf2a | 2020-05-04 | Sergey Lyapustin | Merge pull request #98 from slyapustin/pyup-update-django-3.0.5-to-3.0.6
4f521ec | 2020-05-04 | pyup-bot | Update django from 3.0.5 to 3.0.6
7976582 | 2020-04-17 | Sergey Lyapustin | Updated Github username
23fda2a | 2020-04-06 | Sergey Lyapustin | Merge pull request #97 from slyapustin/pyup-update-psycopg2-binary-2.8.4-to-2.8.5
3b21409 | 2020-04-06 | pyup-bot | Update psycopg2-binary from 2.8.4 to 2.8.5
```


---

## Templates Snapshot


### demo/templates/demo/login.html

```html
{% extends 'django_classified/_base.html' %}

{% load i18n %}

{% block title %}{% trans "Login" %}{% endblock title %}

{% block body %}

  <div class="row">
    <div class="col-lg-12">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{% trans "Login" %}</h4>
          </div>
          <div class="modal-body">
            <ul>
              <li><a href="{% url "social:begin" "facebook" %}">Facebook</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
```


### templates/base.html

```html
{% extends "django_classified/_base.html" %}

{# This template serves as a bridge between django-registration 
   and your existing _base.html template structure #}
```


### templates/django_classified/login.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n %}

{% block title %}Login{% endblock %}

{% block body %}
<div class="container" style="max-width:400px;margin-top:30px">
  <h3>Accedi</h3>

  <!-- Form username/password -->
  <form method="post" action="{% url 'login' %}">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-group">
      <label for="id_username">{% trans "Username" %}</label>
      {{ form.username }} {{ form.username.errors }}
    </div>

    <div class="form-group">
      <label for="id_password">{% trans "Password" %}</label>
      {{ form.password }} {{ form.password.errors }}
    </div>

    <button type="submit" class="btn btn-primary btn-block">{% trans "Entra" %}</button>
  </form>

  <!-- Link reset password -->
  <div style="margin-top:10px;">
    <a href="{% url 'password_reset' %}">{% trans "Password dimenticata?" %}</a>
  </div>

  <!-- Link registrazione -->
  <div style="margin-top:10px;">
    <a href="{% url 'registration_register' %}">{% trans "Non hai un account? Registrati" %}</a>
  </div>

  <hr>

  <!-- Login con Google -->
  <div style="text-align:center;margin-bottom:8px;">
    <a class="btn btn-default" href="{% url 'social:begin' 'google-oauth2' %}?next=/">
      <img src="https://developers.google.com/identity/images/g-logo.png" 
           alt="Google" style="height:18px;vertical-align:middle;margin-right:6px;">
      Accedi con Google
    </a>
  </div>

  <!-- Login con Facebook -->
  <div style="text-align:center;">
    <a class="btn btn-default" href="{% url 'social:begin' 'facebook' %}?next=/">
      Accedi con Facebook
    </a>
  </div>
</div>
{% endblock %}
```


### templates/django_classified/password_reset_complete.html

```html
{% extends "django_classified/_base.html" %}
{% block title %}Password aggiornata{% endblock %}
{% block body %}
<h3>Password aggiornata</h3>
<p>Ora puoi effettuare lâ€™accesso con la nuova password.</p>
<a class="btn btn-default" href="{% url 'login' %}">Vai al login</a>
{% endblock %}
```


### templates/django_classified/password_reset_confirm.html

```html
{% extends "django_classified/_base.html" %}
{% block title %}Imposta nuova password{% endblock %}
{% block body %}
<h3>Imposta una nuova password</h3>
{% if validlink %}
  <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="form-group">
      <label for="id_new_password1">Nuova password</label>
      {{ form.new_password1 }}
      {{ form.new_password1.errors }}
    </div>
    <div class="form-group">
      <label for="id_new_password2">Conferma</label>
      {{ form.new_password2 }}
      {{ form.new_password2.errors }}
    </div>
    <button class="btn btn-primary" type="submit">Aggiorna password</button>
  </form>
{% else %}
  <p class="text-warning">Il link non Ã¨ piÃ¹ valido. Richiedi un nuovo reset.</p>
{% endif %}
{% endblock %}
```


### templates/django_classified/password_reset_done.html

```html
{% extends "django_classified/_base.html" %}
{% block title %}Email inviata{% endblock %}
{% block body %}
<h3>Controlla la tua casella email</h3>
<p>Se lâ€™indirizzo Ã¨ registrato, abbiamo inviato un link per reimpostare la password.</p>
{% endblock %}
```


### templates/django_classified/password_reset_form.html

```html
{% extends "django_classified/_base.html" %}
{% block title %}Password reset{% endblock %}
{% block body %}
<h3>Password reset</h3>
<p>Inserisci lâ€™email del tuo account. Riceverai un link per reimpostare la password.</p>
<form method="post">
  {% csrf_token %}
  {{ form.email.errors }}
  <div class="form-group">
    <label for="id_email">Email</label>
    {{ form.email }}
  </div>
  <button class="btn btn-primary" type="submit">Invia</button>
</form>
{% endblock %}
```


### templates/django_classified/profile.html

```html
{% extends "django_classified/_base.html" %}

{% load i18n bootstrap %}

{% block title %}{% trans "Profile" %}{% endblock title %}

{% block body %}
  <div class="row marketing">
    <div class="col-lg-12">
      <form method="post" role="form">
        {% csrf_token %}
        {{ form|bootstrap }}
        <input type="submit" value="{% trans "Update" %}" class="btn btn-default">
      </form>
    </div>
  </div>
{% endblock %}
```


### templates/django_classified/_base.html

```html
{% spaceless %}

  {% load static i18n %}

  <!DOCTYPE HTML>
  <html lang="en">

  <head>
    <title>{% block title %}NINVENDO - A swap and market place for nintendo lovers{% endblock %}</title>

    <meta name="description" content="NINVENDO - A swap and market place for nintendo lovers">
    <meta name="keywords" content="{% block meta_keywords %}{% endblock meta_keywords %}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% if GOOGLE_SITE_VERIFICATION_ID %}
      <meta name="google-site-verification" content="{{ GOOGLE_SITE_VERIFICATION_ID }}"/>
    {% endif %}
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    {% if FACEBOOK_APP_ID %}
      <meta property="fb:app_id" content="{{ FACEBOOK_APP_ID }}"/>
    {% endif %}
    <meta property="og:type" content="website"/>
    {% block meta_og %}{% endblock %}

    <link rel="icon" type="image/x-icon" href="{% static 'django_classified/images/favicon.ico' %}"/>

    <link href="{% static 'django_classified/css/bootstrap.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'django_classified/css/jumbotron-narrow.css' %}" rel="stylesheet"/>
    <link href="{% static 'django_classified/css/lightbox.min.css' %}" rel="stylesheet" type="text/css"/>
    <link href="{% static 'django_classified/css/style.css' %}" rel="stylesheet" type="text/css"/>

    <link rel="alternate" type="application/rss+xml" href="{% url 'django_classified:rss' %}">

  </head>

  <body>
  <div class="container">

    <div class="header clearfix">
      <nav>
        <ul class="nav nav-pills pull-right">
          <li role="presentation" class="active"><a
                  href="{% url 'django_classified:item-new' %}">{% trans "Add new" %}</a>
          </li>
          <li role="presentation"><a href="{% url 'django_classified:index' %}">{% trans "Home" %}</a></li>
          <li role="presentation"><a href="{% url 'django_classified:search' %}">{% trans "Search" %}</a></li>
          {% if user.is_authenticated %}
            <li role="presentation" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <span class="glyphicon glyphicon-user"></span> {{ user.username }} <span class="caret"></span>
              </a>
              
            <ul class="dropdown-menu">
                <!-- SEZIONE PERSONALE -->
                <li><a href="{% url 'django_classified:user-items' %}">{% trans "My items" %} ({{ user.item_set.count }})</a></li>
                <li><a href="{% url 'trade:profile' %}">ğŸ”§ Il Mio Profilo</a></li>

                <li class="divider"></li>

                <!-- SEZIONE VENDITE -->
                <li class="dropdown-header">ğŸª VENDITE</li>
                <li><a href="{% url 'payments:seller_requests' %}">ğŸ“‹ Richieste Ricevute</a></li>
                <li><a href="{% url 'payments:sales_history' %}">ğŸ’¸ Le Mie Vendite</a></li>
                <li><a href="{% url 'payments:seller_setup' %}">âš™ï¸ Impostazioni Vendite</a></li>

                <li class="divider"></li>

                <!-- SEZIONE ACQUISTI -->
                <li class="dropdown-header">ğŸ›’ ACQUISTI</li>
                <li><a href="{% url 'payments:purchase_history' %}">ğŸ’° I Miei Acquisti</a></li>

                <li class="divider"></li>

                <!-- SEZIONE SCAMBI -->
                <li class="dropdown-header">ğŸ”„ SCAMBI</li>
                <li><a href="{% url 'trade:inbox' %}">ğŸ“¥ Scambi (ricevuti)</a></li>
                <li><a href="{% url 'trade:sent' %}">ğŸ“¤ Scambi (inviati)</a></li>

                <li class="divider"></li>
                
                <!-- LOGOUT -->
                <li>
                    <form method="post" action="{% url 'logout' %}" style="margin:0; padding:0;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link" style="padding: 0; color: #337ab7;">
                            {% trans "Logout" %}
                        </button>
                    </form>
                </li>
            </ul>
            </li>
          {% else %}
            <li role="presentation">
              <a href="{% url 'django_classified:profile' %}" title="{% trans "Login" %}">
                <span class="glyphicon glyphicon-user"></span> {% trans "Login" %}
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
      <h4 class="text-muted"><a href="{% url 'django_classified:index' %}">{{ DCF.SITE_NAME }}</a>
        {% if area_list %}
          &nbsp;
          <small>
            <select id="area-selector">
              <option value="">{% trans 'All areas' %}</option>
              {% for area_item in area_list %}
                <option value="{{ area_item.slug }}" {% if area.pk == area_item.pk %}selected{% endif %}>
                  {{ area_item }}
                </option>
              {% endfor %}
            </select>
          </small>
        {% endif %}
      </h4>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class='row'>
          <div class="col-md-12">
            <div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>
              <button type="button" class="close" data-dismiss="alert">Ã—</button>
              {{ message|safe }}
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}

    {% block body %}

    {% endblock %}

    <footer class="footer">
      <span class="pull-left">{{ DCF.SITE_NAME }}</span>
      {% if DCF.DISPLAY_CREDITS %}
        <span class="pull-right">{% trans "Powered by" %} <a href="https://github.com/slyapustin/NINVENDO"
                                                             title="NINVENDO Ads">NINVENDO Ads (v{{ DCF.VERSION }})</a></span>
      {% endif %}
    </footer>

  </div>

  <script src="{% static 'django_classified/js/jquery-3.3.1.min.js' %}"></script>
  <script src="{% static 'django_classified/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'django_classified/js/lightbox.min.js' %}"></script>

  {% block ext_scripts %}{% endblock %}

  {% if GOOGLE_ANALYTICS_PROPERTY_ID %}
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

      ga('create', '{{ GOOGLE_ANALYTICS_PROPERTY_ID }}', 'auto');
      ga('send', 'pageview');
    </script>
  {% endif %}

  <script>
    $(function () {
      $('#area-selector').on('change', function () {
        var params = {
          area_slug: this.value,
          next: window.location.href
        };
        window.location = "{% url 'django_classified:set-area' %}?" + $.param(params);
      });
    });
  </script>

  <!-- generated {% now "jS F Y H:i:s" %} -->
  </body>
  </html>
{% endspaceless %}
```


### templates/registration/registration_complete.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n %}

{% block title %}{% trans "Registrazione completata" %}{% endblock %}

{% block body %}
<div class="container" style="max-width:500px; margin-top:30px;">
  <h3>{% trans "Registrazione completata!" %}</h3>
  <p>{% trans "Ora puoi accedere al tuo account con le credenziali scelte." %}</p>
  <a href="{% url 'login' %}" class="btn btn-primary">{% trans "Vai al login" %}</a>
</div>
{% endblock %}
```


### templates/registration/registration_form.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n %}

{% block title %}{% trans "Registrazione" %}{% endblock %}

{% block body %}
<div class="container" style="max-width:500px; margin-top:30px;">
  <h3>{% trans "Crea un nuovo account" %}</h3>

  <form method="post" action="">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="form-group">
      <label for="id_username">{% trans "Username" %}</label>
      {{ form.username }}
      {{ form.username.errors }}
    </div>

    <div class="form-group">
      <label for="id_email">{% trans "Email" %}</label>
      {{ form.email }}
      {{ form.email.errors }}
    </div>

    <div class="form-group">
      <label for="id_password1">{% trans "Password" %}</label>
      {{ form.password1 }}
      {{ form.password1.errors }}
    </div>

    <div class="form-group">
      <label for="id_password2">{% trans "Conferma password" %}</label>
      {{ form.password2 }}
      {{ form.password2.errors }}
    </div>

    <button type="submit" class="btn btn-success btn-block">{% trans "Registrati" %}</button>
  </form>

  <div style="margin-top:15px;">
    <p>{% trans "Hai giÃ  un account?" %} <a href="{% url 'login' %}">{% trans "Accedi" %}</a></p>
  </div>
</div>
{% endblock %}
```


### templates/trade/detail.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n widget_tweaks %}

{% block title %}Dettagli Scambio #{{ trade.pk }}{% endblock %}

{% block body %}
<div class="container" style="max-width: 900px;">
    <h3>ğŸ”„ Scambio #{{ trade.pk }}</h3>
    
    <!-- Status -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="alert 
                {% if trade.state == 'sent' %}alert-warning
                {% elif trade.state == 'accepted' %}alert-success
                {% elif trade.state == 'completed' %}alert-info
                {% elif trade.state == 'declined' %}alert-danger
                {% else %}alert-secondary{% endif %}">
                <h4>
                    {% if trade.state == 'sent' %}â³ In Attesa di Risposta
                    {% elif trade.state == 'accepted' %}âœ… Scambio Accettato
                    {% elif trade.state == 'completed' %}ğŸ‰ Scambio Completato
                    {% elif trade.state == 'declined' %}âŒ Scambio Rifiutato
                    {% elif trade.state == 'cancelled' %}ğŸš« Scambio Annullato
                    {% endif %}
                </h4>
                <p class="mb-0">Data: {{ trade.created_at|date:"d/m/Y H:i" }}</p>
            </div>
        </div>
    </div>

    <!-- Dettagli Scambio -->
    <div class="row mb-4">
        <!-- Annuncio Offerto -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5>ğŸ“¤ {{ trade.from_user.username }} Offre</h5>
                </div>
                <div class="card-body">
                    {% if trade.offer_item.image_set.first %}
                        <img src="{{ trade.offer_item.image_set.first.file.url }}" alt="{{ trade.offer_item.title }}" 
                             class="img-fluid mb-3 rounded" style="max-height: 200px; width: 100%; object-fit: cover;">
                    {% endif %}
                    <h6><a href="{{ trade.offer_item.get_absolute_url }}" target="_blank">{{ trade.offer_item.title }}</a></h6>
                    <p><strong>Prezzo:</strong> {{ trade.offer_item.price|floatformat:0 }}â‚¬</p>
                    {% if trade.offer_item.description %}
                        <p class="text-muted small">{{ trade.offer_item.description|truncatewords:15 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Annuncio Richiesto -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>ğŸ“¥ {{ trade.to_user.username }} Riceve</h5>
                </div>
                <div class="card-body">
                    {% if trade.want_item.image_set.first %}
                        <img src="{{ trade.want_item.image_set.first.file.url }}" alt="{{ trade.want_item.title }}" 
                             class="img-fluid mb-3 rounded" style="max-height: 200px; width: 100%; object-fit: cover;">
                    {% endif %}
                    <h6><a href="{{ trade.want_item.get_absolute_url }}" target="_blank">{{ trade.want_item.title }}</a></h6>
                    <p><strong>Prezzo:</strong> {{ trade.want_item.price|floatformat:0 }}â‚¬</p>
                    {% if trade.want_item.description %}
                        <p class="text-muted small">{{ trade.want_item.description|truncatewords:15 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Messaggio Iniziale -->
    {% if trade.message %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ’¬ Messaggio di {{ trade.from_user.username }}</h5>
                </div>
                <div class="card-body">
                    <p>{{ trade.message|linebreaks }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Azioni Scambio Pendente -->
    {% if trade.state == 'sent' %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>âš¡ Azioni Disponibili</h5>
                    </div>
                    <div class="card-body text-center">
                        {% if user == trade.to_user %}
                            <form method="post" action="{% url 'trade:action' trade.pk 'accept' %}" style="display:inline; margin-right: 10px;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-lg"
                                        onclick="return confirm('âœ… Accettare questo scambio?')">
                                    âœ… Accetta Scambio
                                </button>
                            </form>
                            <form method="post" action="{% url 'trade:action' trade.pk 'decline' %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-lg"
                                        onclick="return confirm('âŒ Sei sicuro di rifiutare questo scambio?')">
                                    âŒ Rifiuta
                                </button>
                            </form>
                        {% elif user == trade.from_user %}
                            <p class="text-muted">In attesa di risposta da {{ trade.to_user.username }}...</p>
                            <form method="post" action="{% url 'trade:action' trade.pk 'cancel' %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning"
                                        onclick="return confirm('ğŸš« Annullare la proposta?')">
                                    ğŸš« Annulla Proposta
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    <!-- SEZIONE SCAMBIO ACCETTATO - COMUNICAZIONE INTERNA -->
    {% elif trade.state == 'accepted' %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-success">
                    <h4>âœ… Scambio Accettato!</h4>
                    <p>Organizzate insieme il vostro scambio utilizzando la messaggistica qui sotto oppure i contatti diretti.</p>
                </div>
            </div>
        </div>

        <!-- Informazioni di Contatto -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5>ğŸ‘¤ {{ trade.from_user.username }} (Offerente)</h5>
                    </div>
                    <div class="card-body">
                        {% if trade.from_user.trade_profile_extended %}
                            {% if trade.from_user.trade_profile_extended.phone_number and trade.from_user.trade_profile_extended.show_phone_in_trades %}
                                <p><strong>ğŸ“ Telefono:</strong> 
                                    <a href="tel:{{ trade.from_user.trade_profile_extended.phone_number }}">
                                        {{ trade.from_user.trade_profile_extended.phone_number }}
                                    </a>
                                </p>
                            {% else %}
                                <p class="text-muted">ğŸ“ Telefono: 
                                    {% if not trade.from_user.trade_profile_extended.phone_number %}
                                        Non impostato
                                    {% else %}
                                        Nascosto dall'utente
                                    {% endif %}
                                </p>
                            {% endif %}
                            
                            {% if trade.from_user.trade_profile_extended.location %}
                                <p><strong>ğŸ“ Zona:</strong> {{ trade.from_user.trade_profile_extended.location }}</p>
                            {% else %}
                                <p class="text-muted">ğŸ“ Zona: Non impostata</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">âŒ Profilo non trovato</p>
                        {% endif %}
                        
                        {% if trade.from_user.email %}
                            <p><strong>âœ‰ï¸ Email:</strong> {{ trade.from_user.email }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5>ğŸ‘¤ {{ trade.to_user.username }} (Ricevente)</h5>
                    </div>
                    <div class="card-body">
                        {% if trade.to_user.trade_profile_extended %}
                            {% if trade.to_user.trade_profile_extended.phone_number and trade.to_user.trade_profile_extended.show_phone_in_trades %}
                                <p><strong>ğŸ“ Telefono:</strong> 
                                    <a href="tel:{{ trade.to_user.trade_profile_extended.phone_number }}">
                                        {{ trade.to_user.trade_profile_extended.phone_number }}
                                    </a>
                                </p>
                            {% else %}
                                <p class="text-muted">ğŸ“ Telefono: 
                                    {% if not trade.to_user.trade_profile_extended.phone_number %}
                                        Non impostato
                                    {% else %}
                                        Nascosto dall'utente
                                    {% endif %}
                                </p>
                            {% endif %}
                            
                            {% if trade.to_user.trade_profile_extended.location %}
                                <p><strong>ğŸ“ Zona:</strong> {{ trade.to_user.trade_profile_extended.location }}</p>
                            {% else %}
                                <p class="text-muted">ğŸ“ Zona: Non impostata</p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">âŒ Profilo non trovato</p>
                        {% endif %}
                        
                        {% if trade.to_user.email %}
                            <p><strong>âœ‰ï¸ Email:</strong> {{ trade.to_user.email }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Messaggistica Interna con Supporto Immagini -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>ğŸ’¬ Messaggistica Interna</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cronologia Messaggi con Immagini -->
                        {% if trade_messages %}
                            <div class="messages-history mb-3" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                                {% for msg in trade_messages %}
                                    <div class="message mb-3 {% if msg.sender == user %}text-right{% endif %}">
                                        <div class="message-bubble {% if msg.sender == user %}alert-primary{% else %}alert-light{% endif %} alert py-2 px-3" 
                                             style="display: inline-block; max-width: 80%; text-align: left;">
                                            
                                            <!-- Header del messaggio -->
                                            <small class="text-muted">
                                                <strong>{{ msg.sender.username }}</strong> - {{ msg.created_at|date:"d/m/Y H:i" }}
                                            </small>
                                            
                                            <!-- Contenuto testuale -->
                                            {% if msg.message %}
                                                <div class="mt-1">{{ msg.message|linebreaks }}</div>
                                            {% endif %}
                                            
                                            <!-- Immagine allegata -->
                                            {% if msg.image %}
                                                <div class="mt-2">
                                                    <div class="image-container" style="position: relative;">
                                                        <!-- Thumbnail cliccabile -->
                                                        <img src="{% if msg.get_image_thumbnail_url %}{{ msg.get_image_thumbnail_url }}{% else %}{{ msg.image.url }}{% endif %}" 
                                                             alt="Immagine allegata" 
                                                             class="img-fluid rounded shadow-sm message-image"
                                                             style="max-width: 100%; cursor: pointer; border: 2px solid #dee2e6;"
                                                             onclick="openImageModal('{{ msg.image.url }}', '{{ msg.sender.username }}', '{{ msg.created_at|date:"d/m/Y H:i" }}')">
                                                        
                                                        <!-- Overlay con info -->
                                                        <div class="image-overlay" style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7em;">
                                                            ğŸ“· Clicca per ingrandire
                                                        </div>
                                                        
                                                        <!-- Dimensione file -->
                                                        {% if msg.get_file_size_display %}
                                                            <div class="file-size text-muted" style="font-size: 0.8em; margin-top: 5px;">
                                                                ğŸ“ {{ msg.get_file_size_display }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center">Nessun messaggio ancora. Inizia la conversazione qui sotto!</p>
                        {% endif %}

                        <!-- Form Nuovo Messaggio con Supporto Immagini -->
                        {% if message_form %}
                            <form method="post" action="{% url 'trade:send_message' trade.pk %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <div class="form-group">
                                    <label for="id_message">ğŸ’¬ Scrivi un messaggio:</label>
                                    {{ message_form.message|add_class:"form-control" }}
                                    {% if message_form.message.errors %}
                                        <div class="text-danger">{{ message_form.message.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label for="id_image">ğŸ“· Allega Immagine (opzionale):</label>
                                    {{ message_form.image|add_class:"form-control-file" }}
                                    {% if message_form.image.errors %}
                                        <div class="text-danger">{{ message_form.image.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">Formati supportati: JPG, PNG, GIF (max 5MB)</small>

<<TRUNCATED: showing first 300 lines>>
```


### templates/trade/inbox.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n %}

{% block title %}Scambi Ricevuti{% endblock %}

{% block body %}
<div class="container">
    <h3>ğŸ“¥ Scambi Ricevuti {% if pending_count %}<span class="badge badge-warning">{{ pending_count }}</span>{% endif %}</h3>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <a href="{% url 'trade:inbox' %}" class="btn btn-primary">ğŸ“¥ Ricevuti</a>
            <a href="{% url 'trade:sent' %}" class="btn btn-outline-secondary">ğŸ“¤ Inviati</a>
        </div>
    </div>

    {% if trades %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Da</th>
                        <th>Offre</th>
                        <th>Per</th>
                        <th>Stato</th>
                        <th>Data</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr>
                        <td>
                            <strong>{{ trade.from_user.username }}</strong>
                        </td>
                        <td>
                            <a href="{{ trade.offer_item.get_absolute_url }}">{{ trade.offer_item.title }}</a>
                        </td>
                        <td>
                            <a href="{{ trade.want_item.get_absolute_url }}">{{ trade.want_item.title }}</a>
                        </td>
                        <td>
                            {% if trade.state == 'sent' %}
                                <span class="badge badge-warning">â³ {{ trade.get_state_display }}</span>
                            {% elif trade.state == 'accepted' %}
                                <span class="badge badge-success">âœ… {{ trade.get_state_display }}</span>
                            {% elif trade.state == 'declined' %}
                                <span class="badge badge-danger">âŒ {{ trade.get_state_display }}</span>
                            {% elif trade.state == 'completed' %}
                                <span class="badge badge-info">ğŸ‰ {{ trade.get_state_display }}</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ trade.get_state_display }}</span>
                            {% endif %}
                        </td>
                        <td>{{ trade.created_at|date:"d/m/Y" }}</td>
                        <td>
                            {% if trade.state == 'sent' %}
                                <div class="btn-group btn-group-sm">
                                    <form method="post" action="{% url 'trade:action' trade.pk 'accept' %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success btn-sm"
                                                onclick="return confirm('âœ… Accettare questo scambio?')">
                                            âœ… Accetta
                                        </button>
                                    </form>
                                    <form method="post" action="{% url 'trade:action' trade.pk 'decline' %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm"
                                                onclick="return confirm('âŒ Rifiutare questo scambio?')">
                                            âŒ Rifiuta
                                        </button>
                                    </form>
                                </div>
                            {% elif trade.state == 'accepted' %}
                                <form method="post" action="{% url 'trade:action' trade.pk 'complete' %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary btn-sm"
                                            onclick="return confirm('ğŸ‰ Completare questo scambio?')">
                                        ğŸ‰ Completa
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if trade.message %}
                                <button class="btn btn-info btn-sm" title="{{ trade.message }}" 
                                        data-toggle="tooltip" data-placement="top">ğŸ’¬</button>
                            {% endif %}
                            
                            <a href="{% url 'trade:detail' trade.pk %}" class="btn btn-secondary btn-sm">
                                ğŸ‘ï¸ Dettagli
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <div class="text-center">
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}">&laquo; Precedente</a>
                {% endif %}
                
                Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">Successiva &raquo;</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="alert alert-info">
            <h4>ğŸ“­ Nessuno Scambio Ricevuto</h4>
            <p>Non hai ancora ricevuto proposte di scambio.</p>
            <a href="{% url 'django_classified:index' %}" class="btn btn-primary">Esplora Annunci</a>
        </div>
    {% endif %}
</div>
{% endblock %}
```


### templates/trade/propose.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n widget_tweaks %}

{% block title %}Proponi Scambio{% endblock %}

{% block body %}
<div class="container" style="max-width: 800px;">
    <h3>ğŸ”„ Proponi uno Scambio</h3>
    
    <!-- Annuncio target -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5>ğŸ“ Annuncio Richiesto</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    {% if want_item.image %}
                        <img src="{{ want_item.image.url }}" alt="{{ want_item.title }}" class="img-fluid rounded">
                    {% else %}
                        <div class="bg-light p-3 text-center rounded">Nessuna Immagine</div>
                    {% endif %}
                </div>
                <div class="col-md-9">
                    <h5>{{ want_item.title }}</h5>
                    <p><strong>Proprietario:</strong> {{ want_item.user.username }}</p>
                    <p><strong>Prezzo:</strong> {{ want_item.price }}{{ want_item.currency }}</p>
                    {% if want_item.description %}
                        <p class="text-muted">{{ want_item.description|truncatewords:20 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if not has_items %}
        <!-- Nessun annuncio disponibile -->
        <div class="alert alert-warning">
            <h4>âš ï¸ Nessun Annuncio Disponibile</h4>
            <p>Non hai annunci attivi da offrire per questo scambio.</p>
            <a href="{% url 'django_classified:item-new' %}" class="btn btn-success">âœ¨ Pubblica un Annuncio</a>
            <a href="{{ want_item.get_absolute_url }}" class="btn btn-secondary">â†©ï¸ Torna all'Annuncio</a>
        </div>
    {% else %}
        <!-- Form proposta -->
        <form method="post">
            {% csrf_token %}
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ I Tuoi Annunci</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="{{ form.offer_item.id_for_label }}">Seleziona cosa vuoi offrire:</label>
                        {{ form.offer_item|add_class:"form-control form-control-lg" }}
                        {% if form.offer_item.errors %}
                            <div class="text-danger">{{ form.offer_item.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5>ğŸ’¬ Messaggio</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="{{ form.message.id_for_label }}">Messaggio per {{ want_item.user.username }} (opzionale):</label>
                        {{ form.message|add_class:"form-control" }}
                        {% if form.message.errors %}
                            <div class="text-danger">{{ form.message.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bottoni -->
            <div class="text-center">
                <button type="submit" class="btn btn-success btn-lg">
                    ğŸ“¤ Invia Proposta di Scambio
                </button>
                <a href="{{ want_item.get_absolute_url }}" class="btn btn-secondary btn-lg">
                    âŒ Annulla
                </a>
            </div>
        </form>
    {% endif %}
</div>
{% endblock %}
```


### templates/trade/sent.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n %}

{% block title %}Scambi Inviati{% endblock %}

{% block body %}
<div class="container">
    <h3>ğŸ“¤ Scambi Inviati</h3>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <a href="{% url 'trade:inbox' %}" class="btn btn-outline-secondary">ğŸ“¥ Ricevuti</a>
            <a href="{% url 'trade:sent' %}" class="btn btn-primary">ğŸ“¤ Inviati</a>
        </div>
    </div>

    {% if trades %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>A</th>
                        <th>Ho Offerto</th>
                        <th>Per</th>
                        <th>Stato</th>
                        <th>Data</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr>
                        <td><strong>{{ trade.to_user.username }}</strong></td>
                        <td><a href="{{ trade.offer_item.get_absolute_url }}">{{ trade.offer_item.title }}</a></td>
                        <td><a href="{{ trade.want_item.get_absolute_url }}">{{ trade.want_item.title }}</a></td>
                        <td>
                            {% if trade.state == 'sent' %}
                                <span class="badge badge-warning">â³ In Attesa</span>
                            {% elif trade.state == 'accepted' %}
                                <span class="badge badge-success">âœ… Accettata</span>
                            {% elif trade.state == 'declined' %}
                                <span class="badge badge-danger">âŒ Rifiutata</span>
                            {% elif trade.state == 'completed' %}
                                <span class="badge badge-info">ğŸ‰ Completata</span>
                            {% elif trade.state == 'cancelled' %}
                                <span class="badge badge-secondary">ğŸš« Annullata</span>
                            {% endif %}
                        </td>
                        <td>{{ trade.created_at|date:"d/m/Y" }}</td>
                        <td>
                            {% if trade.state == 'sent' or trade.state == 'accepted' %}
                                <form method="post" action="{% url 'trade:action' trade.pk 'cancel' %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-warning btn-sm"
                                            onclick="return confirm('ğŸš« Annullare questo scambio?')">
                                        ğŸš« Annulla
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if trade.state == 'accepted' %}
                                <form method="post" action="{% url 'trade:action' trade.pk 'complete' %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary btn-sm"
                                            onclick="return confirm('ğŸ‰ Completare questo scambio?')">
                                        ğŸ‰ Completa
                                    </button>
                                </form>
                            {% endif %}
                            
                            <a href="{% url 'trade:detail' trade.pk %}" class="btn btn-secondary btn-sm">
                                ğŸ‘ï¸ Dettagli
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            <h4>ğŸ“­ Nessuna Proposta Inviata</h4>
            <p>Non hai ancora inviato proposte di scambio.</p>
            <a href="{% url 'django_classified:index' %}" class="btn btn-primary">Cerca Annunci da Scambiare</a>
        </div>
    {% endif %}
</div>
{% endblock %}
```


### templates/trade/user_profile.html

```html
{% extends "django_classified/_base.html" %}
{% load i18n widget_tweaks %}

{% block title %}Il Mio Profilo{% endblock %}

{% block body %}
<div class="container" style="max-width: 700px;">
    <h3>ğŸ‘¤ Il Mio Profilo</h3>
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5>ğŸ“ Informazioni di Contatto</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h6>â„¹ï¸ PerchÃ© compilare queste informazioni?</h6>
                <p class="mb-0">Queste informazioni saranno visibili <strong>solo agli utenti con cui hai scambi accettati</strong> per facilitare l'organizzazione dello scambio fisico.</p>
            </div>
            
            <form method="post">
                {% csrf_token %}
                
                <h6>ğŸ“ Contatto Telefonico</h6>
                <div class="form-group">
                    <label for="{{ form.phone_number.id_for_label }}">Numero di Telefono:</label>
                    {{ form.phone_number|add_class:"form-control" }}
                    {% if form.phone_number.errors %}
                        <div class="text-danger">{{ form.phone_number.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">Formato suggerito: +39 123 456 7890</small>
                </div>

                <div class="form-group form-check">
                    {{ form.show_phone_in_trades|add_class:"form-check-input" }}
                    <label class="form-check-label" for="{{ form.show_phone_in_trades.id_for_label }}">
                        Mostra il mio numero di telefono negli scambi accettati
                    </label>
                    {% if form.show_phone_in_trades.errors %}
                        <div class="text-danger">{{ form.show_phone_in_trades.errors }}</div>
                    {% endif %}
                </div>

                <hr>

                <h6>ğŸ“ Localizzazione</h6>
                <div class="form-group">
                    <label for="{{ form.location.id_for_label }}">CittÃ /Zona:</label>
                    {{ form.location|add_class:"form-control" }}
                    {% if form.location.errors %}
                        <div class="text-danger">{{ form.location.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">Es. Milano, Roma, Napoli, etc. Aiuta gli altri utenti a sapere se siete nella stessa zona</small>
                </div>

                <hr>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">ğŸ’¾ Salva Profilo</button>
                    <a href="{% url 'django_classified:index' %}" class="btn btn-secondary">âŒ Annulla</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistiche Scambi -->
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5>ğŸ“Š Le Mie Statistiche</h5>
        </div>
        <div class="card-body">
            {% if user.trade_profile %}
                <div class="row">
                    <div class="col-md-4 text-center">
                        <h4 class="text-primary">{{ user.trade_profile.total_trades_completed }}</h4>
                        <p class="text-muted">Scambi Completati</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h4 class="text-warning">{{ user.trade_profile.average_rating|floatformat:1 }}/5 â­</h4>
                        <p class="text-muted">Rating Medio</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <h4 class="text-info">{{ user.trade_profile.total_feedbacks_received }}</h4>
                        <p class="text-muted">Valutazioni Ricevute</p>
                    </div>
                </div>
            {% else %}
                <p class="text-muted text-center">Completa il tuo primo scambio per vedere le statistiche!</p>
            {% endif %}
        </div>
    </div>

    <!-- Informazioni Attuali -->
    {% if profile.phone_number or profile.location %}
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5>ğŸ‘ï¸ Anteprima delle Tue Informazioni</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Ecco come vedranno le tue informazioni gli altri utenti negli scambi accettati:</p>
            
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6>ğŸ‘¤ {{ user.username }}</h6>
                </div>
                <div class="card-body">
                    {% if profile.phone_number and profile.show_phone_in_trades %}
                        <p><strong>ğŸ“ Telefono:</strong> {{ profile.phone_number }}</p>
                    {% else %}
                        <p class="text-muted">ğŸ“ Telefono: Non disponibile</p>
                    {% endif %}
                    
                    {% if profile.location %}
                        <p><strong>ğŸ“ Zona:</strong> {{ profile.location }}</p>
                    {% endif %}
                    
                    <p><strong>âœ‰ï¸ Email:</strong> {{ user.email }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
```


---

## Key Files (redacted excerpts)


### manage.py

```python
#!/usr/bin/env python
import os
import sys

if __name__ == "__main__":
    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "project.settings")

    from django.core.management import execute_from_command_line

    execute_from_command_line(sys.argv)
```


### Procfile

```
web: gunicorn wsgi:application
release: python manage.py migrate --noinput
```


### README.md

```
# Django Classified Demo website

[Django-classified](https://github.com/slyapustin/django-classified) demo project with user authorization via Facebook or Email.

## Deploy to DigitalOcean

Click the button below to deploy the Django Classified Demo app to DigitalOcean:

[![Deploy to DO](https://www.deploytodo.com/do-btn-blue.svg)](https://cloud.digitalocean.com/apps/new?repo=https://github.com/slyapustin/django-classified-demo/tree/master&refcode=08ce1ee690de)

Use username `admin` and password `admin` to login to the admin panel.

## Customization

- Note: `python ./manage.py setup_project` command will load initial data to populate app Sections, Groups and Areas based on [craigslist.org](http://craigslist.org) website structure.

## Run locally

Create `.env ` file with your local settings (use `.env.example` as an example).

- Create Virtual Environment and install requirements via `pip install -r requirements.txt`.
- Create initial database schema `python ./manage.py migrate`
- Collect static files `python ./manage.py collectstatic`
- Start local development server `python ./manage.py runserver`
- Visit http://127.0.0.1:8000/
```


### requirements.txt

```

boto3==1.35.92 
django-classified==1.1.1
django-environ==0.11.2
django==5.1.8
gunicorn==23.0.0
psycopg2-binary==2.9.10
python-memcached==1.62
social-auth-app-django==5.4.2
whitenoise==6.8.2
django-fsm==3.0.0


django-crispy-forms==2.1
crispy-bootstrap4==2024.1
django-widget-tweaks==1.5.0
django-extensions==3.2.3


django-notifications-hq==1.8.0  

stripe==7.0.0
```


### payments/urls.py

```python
# payments/urls.py - VERSIONE CORRETTA COMPLETA

from django.urls import path
from . import views

app_name = "payments"

urlpatterns = [
    # Richiesta di acquisto
    path('request/<int:item_id>/', views.RequestPurchaseView.as_view(), name='request_purchase'),
    path('request/<uuid:uuid>/', views.PurchaseRequestDetailView.as_view(), name='request_detail'),
    path('request/<uuid:uuid>/<str:action>/', views.ProcessPurchaseRequestView.as_view(), name='process_request'),
    
    # Pagamento
    path('checkout/<uuid:uuid>/', views.CreateCheckoutSessionView.as_view(), name='create_checkout'),
    path('success/<uuid:uuid>/', views.PaymentSuccessView.as_view(), name='payment_success'),
    path('cancelled/<uuid:uuid>/', views.PaymentCancelledView.as_view(), name='payment_cancelled'),
    
    # ğŸ”¥ AGGIUNGI QUESTI URL MANCANTI:
    path('transaction/<uuid:uuid>/', views.PaymentTransactionDetailView.as_view(), name='transaction_detail'),
    
    # Cronologie
    path('purchases/', views.PurchaseHistoryView.as_view(), name='purchase_history'),
    path('sales/', views.SalesHistoryView.as_view(), name='sales_history'),
    
    # ğŸ”¥ AGGIUNGI QUESTO URL PER I VENDITORI:
    path('seller/requests/', views.SellerRequestsView.as_view(), name='seller_requests'),
    
    # Configurazione venditore
    path('seller/setup/', views.SellerSetupView.as_view(), name='seller_setup'),
    
    # Webhook Stripe
    path('stripe/webhook/', views.stripe_webhook, name='stripe_webhook'),

    # In payments/urls.py, aggiungi:
    path('transaction/<uuid:uuid>/', views.PaymentTransactionDetailView.as_view(), name='transaction_detail'),
]
```


### project/settings.py

```python
# -*- coding:utf-8 -*-
import os

import environ

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

env = environ.Env(
    DEBUG=(bool, False),
    CACHE_URL=(str, 'locmemcache://'),
    EMAIL_URL=(str, 'consolemail://'),
    SECRET_KEY=(str, 'secret'),
    DATABASE_URL=(str, 'sqlite:///db.sqlite'),
)

env.read_env(str(os.path.join(BASE_DIR, ".env")))

DEBUG = env('DEBUG')
SECRET_KEY = env('SECRET_KEY')


ADMINS = (
    ('Demo Classified Admin', os.environ.get('ADMIN_EMAIL', '***REDACTED***')),
)

MANAGERS = ADMINS

# Expected comma separated string with the ALLOWED_HOSTS list
ALLOWED_HOSTS = os.environ.get('ALLOWED_HOSTS', '***REDACTED***').split(',')

# (Opzionale ma utile in deploy dietro proxy/Render per OAuth)
# Comma-separated, es: "https://nintendo-swap.onrender.com"
CSRF_TRUSTED_ORIGINS = os.environ.get('CSRF_TRUSTED_ORIGINS', '***REDACTED***') if os.environ.get('CSRF_TRUSTED_ORIGINS') else []

DATABASES = {
    'default': env.db(),
}

# Cache configuration for development
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'default-cache',
        'OPTIONS': {
            'MAX_ENTRIES': 1000,
            'CULL_FREQUENCY': 3,
        }
    }
}

# Local time zone for this installation. Choices can be found here:
# http://en.wikipedia.org/wiki/List_of_tz_zones_by_name
# although not all choices may be available on all operating systems.
# On Unix systems, a value of None will cause Django to use the same
# timezone as the operating system.
# If running in a Windows environment this must be set to the same as your
# system time zone.
TIME_ZONE = 'UTC'

# Language code for this installation. All choices can be found here:
# http://www.i18nguy.com/unicode/language-identifiers.html
LANGUAGE_CODE = 'en-us'

SITE_ID = 1

# If you set this to False, Django will make some optimizations so as not
# to load the internationalization machinery.
USE_I18N = True

# If you set this to False, Django will not format dates, numbers and
# calendars according to the current locale
USE_L10N = True

USE_TZ = True
# Absolute filesystem path to the directory that will hold user-uploaded files.
# Example: '/home/media/media.lawrence.com/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# URL that handles the media served from MEDIA_ROOT. Make sure to use a
# trailing slash.
# Examples: 'http://media.lawrence.com/media/', 'http://example.com/media/'
MEDIA_URL = "/media/"

# Absolute path to the directory static files should be collected to.
# Don't put anything in this directory yourself; store your static files
# in apps' 'static/' subdirectories and in STATICFILES_DIRS.
# Example: '/home/media/media.lawrence.com/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')

# URL prefix for static files.
# Example: 'http://media.lawrence.com/static/'
STATIC_URL = '/static/'

# URL prefix for admin static files -- CSS, JavaScript and images.
# Make sure to use a trailing slash.
# Examples: 'http://foo.com/static/admin/', '/static/admin/'.

# Additional locations of static files
STATICFILES_DIRS = (

    # Put strings here, like '/home/html/static' or 'C:/www/django/static'.
    # Always use forward slashes, even on Windows.
    # Don't forget to use absolute paths, not relative paths.
)

STORAGES = {
    "default": {
        "BACKEND": "django.core.files.storage.FileSystemStorage",
    },
    "staticfiles": {
        "BACKEND": "whitenoise.storage.CompressedManifestStaticFilesStorage",
    },
}

MIDDLEWARE = (
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.locale.LocaleMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
)

# ğŸ” Backends: Google OAuth2 + username/password Django (e manteniamo Facebook se giÃ  configurato)
AUTHENTICATION_BACKENDS = (
    'social_core.backends.google.GoogleOAuth2',     # Google Login
    'social_core.backends.facebook.FacebookOAuth2', # (opzionale) Facebook giÃ  presente
    'django.contrib.auth.backends.ModelBackend',    # Username/Password nativo Django
)

ROOT_URLCONF = 'project.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'APP_DIRS': True,
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',

                # Social Auth context processors
                'social_django.context_processors.backends',
                'social_django.context_processors.login_redirect',

                # Django Classified context processors
                'django_classified.context_processors.common_values'
            ],
            'debug': True
        },
    },
]

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.humanize',
    'django.contrib.messages',
    'django.contrib.sessions',
    'django.contrib.sitemaps',
    'django.contrib.sites',
    'django.contrib.staticfiles',

    'bootstrapform',
    'sorl.thumbnail',
    'django_classified',
    'social_django',

    # â­ MODULI ESSENZIALI PER BARATTO
    'crispy_forms',         # django-crispy-forms
    'crispy_bootstrap4',    # crispy bootstrap4 template pack
    'widget_tweaks',        # django-widget-tweaks
    'django_extensions',    # utilities per sviluppo

    'demo',
    'registration',  
    "trade",
    'payments'
]

# â­ CONFIGURAZIONI CRISPY FORMS
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap4"
CRISPY_TEMPLATE_PACK = "bootstrap4"

# Email per notifiche (giÃ  presente, assicuriamoci sia configurato)
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'  # development
# EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'  # production

ACCOUNT_ACTIVATION_DAYS = 7  # per backend 'default' (con email)


LOGIN_REDIRECT_URL = '/'
LOGIN_URL = '/login/'
LOGOUT_REDIRECT_URL = '/'

DCF_SITE_NAME = 'NinVendo : a place for NinTendo lovers'

# ---- Social Auth: Google (aggiunto) ----
# Imposta questi valori nell'ambiente (.env o Render env)
SOCIAL_AUTH_GOOGLE_OAUTH2_KEY = '***REDACTED***'SOCIAL_AUTH_GOOGLE_OAUTH2_KEY')
SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET = '***REDACTED***'SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET')

# Se sei dietro proxy/https terminato a monte (es. Render), abilita il redirect HTTPS:
# In locale lascialo False; in produzione metti env SOCIAL_AUTH_REDIRECT_IS_HTTPS='***REDACTED***'
SOCIAL_AUTH_REDIRECT_IS_HTTPS = '***REDACTED***'SOCIAL_AUTH_REDIRECT_IS_HTTPS', default=False)

# ---- Social Auth: Facebook (giÃ  presente, opzionale) ----
# You need to obtain Facebook Keys
# Check docs for more info here:
# https://python-social-auth.readthedocs.io/en/latest/backends/facebook.html
SOCIAL_AUTH_FACEBOOK_KEY = '***REDACTED***'SOCIAL_AUTH_FACEBOOK_KEY')
SOCIAL_AUTH_FACEBOOK_SECRET = '***REDACTED***'SOCIAL_AUTH_FACEBOOK_SECRET')
SOCIAL_AUTH_FACEBOOK_SCOPE = '***REDACTED***'email']
SOCIAL_AUTH_FACEBOOK_PROFILE_EXTRA_PARAMS = '***REDACTED***'
    'fields': 'id, name, email'
}

SOCIAL_AUTH_EMAIL_FORM_HTML = '***REDACTED***'
SOCIAL_AUTH_EMAIL_VALIDATION_URL = '***REDACTED***'

SOCIAL_AUTH_PIPELINE = '***REDACTED***'
    'social_core.pipeline.social_auth.social_details',
    'social_core.pipeline.social_auth.social_uid',
    'social_core.pipeline.social_auth.auth_allowed',
    'social_core.pipeline.social_auth.social_user',
    'social_core.pipeline.user.get_username',
    'social_core.pipeline.mail.mail_validation',
    'social_core.pipeline.user.create_user',
    'social_core.pipeline.social_auth.associate_user',
    'social_core.pipeline.debug.debug',
    'social_core.pipeline.social_auth.load_extra_data',
    'social_core.pipeline.user.user_details',
    'social_core.pipeline.debug.debug'
)

DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL', '***REDACTED***')

DEFAULT_AUTO_FIELD = 'django.db.models.AutoField'

# Configure email Backend via EMAIL_URL
vars().update(env.email_url())

DCF_CURRENCY = 'EUR'
DCF_DISPLAY_EMPTY_GROUPS = True
GOOGLE_ANALYTICS_PROPERTY_ID = os.environ.get('GOOGLE_ANALYTICS_PROPERTY_ID')


# Aggiungi questa sezione alla fine del tuo project/settings.py

# ============================================
# CONFIGURAZIONE STRIPE PAGAMENTI (TEMPORANEA)
# ============================================

# Configurazione temporanea per testing (sostituisci con chiavi reali)
STRIPE_PUBLIC_KEY = env('STRIPE_PUBLIC_KEY', default='pk_test_placeholder')
STRIPE_SECRET_KEY = env('STRIPE_SECRET_KEY', default='sk_test_placeholder') 
STRIPE_WEBHOOK_SECRET = env('STRIPE_WEBHOOK_SECRET', default='whsec_placeholder')

# Dominio per redirect Stripe
STRIPE_DOMAIN = env('STRIPE_DOMAIN', default='http://127.0.0.1:8000')

# Commissioni
PLATFORM_FEE_PERCENTAGE = env.float('PLATFORM_FEE_PERCENTAGE', default=3.0)
STRIPE_FEE_PERCENTAGE = env.float('STRIPE_FEE_PERCENTAGE', default=1.4)
STRIPE_FEE_FIXED_CENTS = env.int('STRIPE_FEE_FIXED_CENTS', default=25)
```


### project/urls.py

```python
from django.urls import include, re_path, path
from django.contrib import admin
from django.contrib.auth import views as auth_views
from django.views.generic import TemplateView
from django.conf.urls.static import static
from django.conf import settings



urlpatterns = [
    re_path('', include('django_classified.urls', namespace='django_classified')),
    re_path('social/', include('social_django.urls', namespace='social')),
    path('admin/', admin.site.urls),

    # Auth base
    path('login/', auth_views.LoginView.as_view(template_name='django_classified/login.html'), name='login'),
    path('logout/', auth_views.LogoutView.as_view(next_page='/'), name='logout'),

    # Password reset (flow completo)
    path('password-reset/', auth_views.PasswordResetView.as_view(
        template_name='django_classified/password_reset_form.html',
        email_template_name='django_classified/password_reset_email.txt',
        subject_template_name='django_classified/password_reset_subject.txt',
        success_url='/password-reset/done/'
    ), name='password_reset'),

    path('password-reset/done/', auth_views.PasswordResetDoneView.as_view(
        template_name='django_classified/password_reset_done.html'
    ), name='password_reset_done'),

    path('reset/<uidb64>/<token>/', auth_views.PasswordResetConfirmView.as_view(
        template_name='django_classified/password_reset_confirm.html',
        success_url='/reset/done/'
    ), name='password_reset_confirm'),

    path('reset/done/', auth_views.PasswordResetCompleteView.as_view(
        template_name='django_classified/password_reset_complete.html'
    ), name='password_reset_complete'),

    # Pagina usata da social auth (se serve)
    path('email-sent/', TemplateView.as_view(template_name='django_classified/email_sent.html'), name='email_sent'),

    # Registrazione utenti (django-registration-redux, backend simple)
    path('accounts/', include('registration.backends.simple.urls')),

    # Modulo "baratto"
    path('trade/', include('trade.urls', namespace='trade')),

    # â­ NUOVO MODULO PAGAMENTI
    path('payments/', include('payments.urls', namespace='payments')),  # <-- Aggiungi questa riga
]


# Alla fine del file
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```


### trade/urls.py

```python
from django.urls import path
from . import views

app_name = "trade"

urlpatterns = [
    # Liste scambi
    path("inbox/", views.InboxTradesView.as_view(), name="inbox"),
    path("sent/", views.SentTradesView.as_view(), name="sent"),
    
    # Statistiche utente (deve essere prima di <int:pk>/)
    path("user/<str:username>/stats/", views.UserTradeStatsView.as_view(), name="user_stats"),
    
    # Dettaglio e proposta
    path("propose/<int:item_id>/", views.ProposeTradeView.as_view(), name="propose"),
    
    # Feedback e messaggi (DEVONO essere prima di <str:action> per evitare conflitti)
    path("<int:pk>/feedback/", views.SubmitFeedbackView.as_view(), name="feedback"),
    path("<int:pk>/message/", views.SendTradeMessageView.as_view(), name="send_message"),
    
    # Azioni sui scambi (pattern generico, deve essere dopo quelli specifici)
    path("<int:pk>/<str:action>/", views.TradeActionView.as_view(), name="action"),
    
    # Dettaglio (pattern generico, deve essere ultimo)
    path("<int:pk>/", views.TradeDetailView.as_view(), name="detail"),

    # Profilo utente
    path("profile/", views.UserProfileView.as_view(), name="profile"),
    
    
]
```


### payments/admin.py

```python
from django.contrib import admin
from django.urls import reverse
from django.utils.html import format_html
from django.utils import timezone

from .models import PaymentTransaction, SellerProfile, PurchaseRequest


@admin.register(PaymentTransaction)
class PaymentTransactionAdmin(admin.ModelAdmin):
    list_display = [
        'uuid_short', 'buyer', 'seller', 'item_title', 'total_amount_euros',
        'status', 'created_at', 'payment_link'
    ]
    list_filter = ['status', 'currency', 'created_at']
    search_fields = ['uuid', 'buyer__username', 'seller__username', 'item__title', 'stripe_payment_intent_id']
    readonly_fields = [
        'uuid', 'stripe_payment_intent_id', 'stripe_checkout_session_id',
        'created_at', 'updated_at', 'completed_at'
    ]
    
    fieldsets = [
        ('Informazioni Base', {
            'fields': ['uuid', 'status', 'created_at', 'updated_at', 'completed_at']
        }),
        ('Partecipanti', {
            'fields': ['buyer', 'seller', 'item']
        }),
        ('Importi', {
            'fields': [
                'item_price_cents', 'platform_fee_cents', 'stripe_fee_cents',
                'total_amount_cents', 'currency'
            ]
        }),
        ('Dati Stripe', {
            'fields': ['stripe_payment_intent_id', 'stripe_checkout_session_id']
        }),
        ('Dettagli Acquirente', {
            'fields': ['buyer_email', 'buyer_name', 'shipping_address', 'notes']
        }),
    ]
    
    def uuid_short(self, obj):
        return obj.uuid.hex[:8]
    uuid_short.short_description = 'UUID'
    
    def item_title(self, obj):
        return obj.item.title[:50] + ('...' if len(obj.item.title) > 50 else '')
    item_title.short_description = 'Articolo'
    
    def payment_link(self, obj):
        if obj.stripe_payment_intent_id:
            stripe_url = f"https://dashboard.stripe.com/payments/{obj.stripe_payment_intent_id}"
            return format_html('<a href="{}" target="_blank">Vedi su Stripe</a>', stripe_url)
        return '-'
    payment_link.short_description = 'Stripe'
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('buyer', 'seller', 'item')


@admin.register(PurchaseRequest)
class PurchaseRequestAdmin(admin.ModelAdmin):
    list_display = [
        'uuid_short', 'buyer', 'seller', 'item_title', 'status',
        'delivery_method', 'created_at', 'expires_at', 'is_expired_status'
    ]
    list_filter = ['status', 'delivery_method', 'created_at']
    search_fields = ['uuid', 'buyer__username', 'seller__username', 'item__title']
    readonly_fields = ['uuid', 'created_at', 'updated_at', 'is_expired_status']
    
    fieldsets = [
        ('Informazioni Base', {
            'fields': ['uuid', 'status', 'created_at', 'updated_at', 'expires_at']
        }),
        ('Partecipanti', {
            'fields': ['buyer', 'seller', 'item']
        }),
        ('Dettagli Richiesta', {
            'fields': ['message', 'delivery_method', 'shipping_address']
        }),
        ('Pagamento Collegato', {
            'fields': ['payment_transaction']
        }),
    ]
    
    def uuid_short(self, obj):
        return obj.uuid.hex[:8]
    uuid_short.short_description = 'UUID'
    
    def item_title(self, obj):
        return obj.item.title[:50] + ('...' if len(obj.item.title) > 50 else '')
    item_title.short_description = 'Articolo'
    
    def is_expired_status(self, obj):
        if obj.is_expired():
            return format_html('<span style="color: red;">Scaduta</span>')
        elif obj.status == PurchaseRequest.STATUS_PENDING:
            remaining = obj.expires_at - timezone.now()
            hours_remaining = int(remaining.total_seconds() / 3600)
            return format_html('<span style="color: orange;">Scade tra {}h</span>', hours_remaining)
        return 'N/A'
    is_expired_status.short_description = 'Scadenza'
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('buyer', 'seller', 'item', 'payment_transaction')


@admin.register(SellerProfile)
class SellerProfileAdmin(admin.ModelAdmin):
    list_display = [
        'user', 'accepts_payments', 'stripe_onboarding_completed',
        'total_sales', 'total_revenue_euros', 'average_rating'
    ]
    list_filter = ['accepts_payments', 'auto_accept_payments', 'stripe_onboarding_completed']
    search_fields = ['user__username', 'stripe_account_id']
    readonly_fields = [
        'total_sales', 'total_revenue_cents', 'average_rating',
        'created_at', 'updated_at'
    ]
    
    fieldsets = [
        ('Utente', {
            'fields': ['user']
        }),
        ('Configurazione Stripe', {
            'fields': ['stripe_account_id', 'stripe_onboarding_completed']
        }),
        ('Impostazioni Vendita', {
            'fields': ['accepts_payments', 'auto_accept_payments']
        }),
        ('Statistiche', {
            'fields': ['total_sales', 'total_revenue_cents', 'average_rating']
        }),
        ('Timestamp', {
            'fields': ['created_at', 'updated_at']
        }),
    ]
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')
    
    actions = ['update_seller_stats']
    
    def update_seller_stats(self, request, queryset):
        """Action per aggiornare le statistiche dei venditori selezionati"""
        count = 0
        for profile in queryset:
            profile.update_stats()
            count += 1
        
        self.message_user(
            request,
            f'Statistiche aggiornate per {count} venditori.'
        )
    update_seller_stats.short_description = 'Aggiorna statistiche venditori'
```


### payments/apps.py

```python

from django.apps import AppConfig


class PaymentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'payments'
    verbose_name = 'Sistema Pagamenti'
    
    def ready(self):
        """
        Codice da eseguire quando l'app Ã¨ pronta
        """
        try:
            # Import dei signal handlers se necessario
            import payments.signals
        except ImportError:
            pass
```


### payments/forms.py

```python
from django import forms
from django.core.exceptions import ValidationError
from crispy_forms.helper import FormHelper
from crispy_forms.layout import Layout, Submit, HTML, Row, Column, Div, Field

from django_classified.models import Item
from .models import PurchaseRequest, SellerProfile


class PurchaseRequestForm(forms.ModelForm):
    """Form per richiedere l'acquisto di un annuncio"""
    
    class Meta:
        model = PurchaseRequest
        fields = ['message', 'delivery_method', 'shipping_address']
        widgets = {
            'message': forms.Textarea(attrs={
                'rows': 4,
                'placeholder': 'Scrivi un messaggio opzionale al venditore...',
                'class': 'form-control'
            }),
            'delivery_method': forms.Select(attrs={'class': 'form-control'}),
            'shipping_address': forms.Textarea(attrs={
                'rows': 3,
                'placeholder': 'Inserisci il tuo indirizzo completo per la spedizione...',
                'class': 'form-control'
            }),
        }
    
    def __init__(self, item, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.item = item
        
        # Labels personalizzate
        self.fields['message'].label = 'Messaggio al Venditore'
        self.fields['delivery_method'].label = 'Metodo di Consegna Preferito'
        self.fields['shipping_address'].label = 'Indirizzo di Spedizione'
        
        # Il campo indirizzo Ã¨ opzionale ma richiesto se scegli spedizione
        self.fields['shipping_address'].required = False
        
        # Help text
        self.fields['message'].help_text = 'Presenta te stesso e specifica eventuali domande sull\'articolo'
        self.fields['delivery_method'].help_text = 'Come preferisci ricevere l\'articolo?'
        self.fields['shipping_address'].help_text = 'Necessario solo se scegli "Spedizione" o "Entrambi"'
        
        # Crispy Forms layout
        try:
            self.helper = FormHelper()
            self.helper.form_method = "post"
            self.helper.layout = Layout(
                HTML(f'''
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5>ğŸ›’ Richiesta di Acquisto</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Articolo:</strong> {self.item.title}</p>
                            <p><strong>Venditore:</strong> {self.item.user.username}</p>
                            <p><strong>Prezzo:</strong> {self.item.price}â‚¬</p>
                        </div>
                    </div>
                '''),
                
                Field('message'),
                HTML('<hr>'),
                
                HTML('<h6>ğŸšš ModalitÃ  di Consegna</h6>'),
                Field('delivery_method', css_class='form-control mb-3'),
                
                Field('shipping_address', css_class='address-field'),
                
                HTML('''
                    <div class="alert alert-info">
                        <h6>â„¹ï¸ Come Funziona</h6>
                        <ol>
                            <li>Invia la richiesta al venditore</li>
                            <li>Il venditore approva la richiesta</li>
                            <li>Procedi al pagamento sicuro con Stripe</li>
                            <li>Ricevi l'articolo secondo l'accordo</li>
                        </ol>
                    </div>
                '''),
                
                HTML('<hr>'),
                Div(
                    Submit('submit', 'ğŸ“¤ Invia Richiesta di Acquisto', css_class='btn btn-primary btn-lg btn-block'),
                    css_class='text-center'
                )
            )
        except ImportError:
            pass
    
    def clean(self):
        cleaned_data = super().clean()
        delivery_method = cleaned_data.get('delivery_method')
        shipping_address = cleaned_data.get('shipping_address', '').strip()
        
        # Se ha scelto spedizione, l'indirizzo Ã¨ obbligatorio
        if delivery_method in ['shipping', 'both'] and not shipping_address:
            raise ValidationError({
                'shipping_address': 'L\'indirizzo di spedizione Ã¨ richiesto per il metodo di consegna selezionato.'
            })
        
        return cleaned_data


class SellerOnboardingForm(forms.ModelForm):
    """Form per configurazione venditore"""
    
    class Meta:
        model = SellerProfile
        fields = ['accepts_payments', 'auto_accept_payments']
        widgets = {
            'accepts_payments': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
            'auto_accept_payments': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        self.fields['accepts_payments'].label = 'Accetta pagamenti online'
        self.fields['auto_accept_payments'].label = 'Approva automaticamente le richieste di acquisto'
        
        self.fields['accepts_payments'].help_text = 'Permetti agli utenti di acquistare i tuoi annunci con pagamenti online'
        self.fields['auto_accept_payments'].help_text = 'Le richieste saranno approvate automaticamente (sconsigliato per articoli di valore elevato)'
        
        # Crispy Forms layout
        try:
            self.helper = FormHelper()
            self.helper.form_method = "post"
            self.helper.layout = Layout(
                HTML('<h4>ğŸ’° Configurazione Vendite</h4>'),
                
                Div(
                    Field('accepts_payments'),
                    HTML('<small class="form-text text-muted">Permetti agli utenti di acquistare i tuoi annunci online</small>'),
                    css_class='form-check mb-3'
                ),
                
                Div(
                    Field('auto_accept_payments'),
                    HTML('<small class="form-text text-muted">Approva automaticamente le richieste (sconsigliato per articoli costosi)</small>'),
                    css_class='form-check mb-3'
                ),
                
                HTML('''
                    <div class="alert alert-warning">
                        <h6>âš ï¸ Commissioni</h6>
                        <p>Su ogni vendita vengono applicate:</p>
                        <ul>
                            <li><strong>3% di commissione piattaforma</strong></li>
                            <li><strong>1.4% + â‚¬0.25 di commissione Stripe</strong></li>
                        </ul>
                        <p class="mb-0">Le commissioni sono automaticamente detratte dal pagamento dell'acquirente.</p>
                    </div>
                '''),
                
                HTML('<hr>'),
                Submit('save', 'ğŸ’¾ Salva Configurazione', css_class='btn btn-success btn-block')
            )
        except ImportError:
            pass


class PaymentFilterForm(forms.Form):
    """Form per filtrare cronologia pagamenti"""
    
    STATUS_CHOICES = [
        ('', 'Tutti gli stati'),
        ('pending', 'In Attesa'),
        ('processing', 'In Elaborazione'),  
        ('succeeded', 'Completato'),
        ('failed', 'Fallito'),
        ('cancelled', 'Annullato'),
        ('refunded', 'Rimborsato'),
    ]
    
    status = forms.ChoiceField(
        choices=STATUS_CHOICES,
        required=False,
        widget=forms.Select(attrs={'class': 'form-control'})
    )
    
    date_from = forms.DateField(
        required=False,
        widget=forms.DateInput(attrs={
            'type': 'date',
            'class': 'form-control'
        })
    )
    
    date_to = forms.DateField(
        required=False,
        widget=forms.DateInput(attrs={
            'type': 'date', 
            'class': 'form-control'
        })
    )
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        self.fields['status'].label = 'Stato'
        self.fields['date_from'].label = 'Dal'
        self.fields['date_to'].label = 'Al'
        
        # Crispy Forms layout
        try:
            self.helper = FormHelper()
            self.helper.form_method = "get"
            self.helper.layout = Layout(
                Row(
                    Column('status', css_class='col-md-4'),
                    Column('date_from', css_class='col-md-4'),
                    Column('date_to', css_class='col-md-4'),
                ),
                HTML('<hr>'),
                Div(
                    Submit('filter', 'ğŸ” Filtra', css_class='btn btn-info'),
                    HTML('<a href="?" class="btn btn-secondary ml-2">ğŸ”„ Reset</a>'),
                    css_class='text-center'
                )
            )
        except ImportError:
            pass
```


### payments/models.py

```python
from django.conf import settings
from django.db import models
from django.urls import reverse
from django.utils import timezone
from decimal import Decimal
import uuid

from django_classified.models import Item


class PaymentTransaction(models.Model):
    """Transazione di pagamento per l'acquisto di un annuncio"""
    
    STATUS_PENDING = 'pending'
    STATUS_PROCESSING = 'processing'
    STATUS_SUCCEEDED = 'succeeded'
    STATUS_FAILED = 'failed'
    STATUS_CANCELLED = 'cancelled'
    STATUS_REFUNDED = 'refunded'
    
    STATUS_CHOICES = [
        (STATUS_PENDING, 'In Attesa'),
        (STATUS_PROCESSING, 'In Elaborazione'),
        (STATUS_SUCCEEDED, 'Completato'),
        (STATUS_FAILED, 'Fallito'),
        (STATUS_CANCELLED, 'Annullato'),
        (STATUS_REFUNDED, 'Rimborsato'),
    ]
    
    # Identificatori
    uuid = models.UUIDField(default=uuid.uuid4, unique=True, editable=False)
    stripe_payment_intent_id = models.CharField(max_length=255, unique=True, null=True, blank=True)
    stripe_checkout_session_id = models.CharField(max_length=255, unique=True, null=True, blank=True)
    
    # Partecipanti
    buyer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.PROTECT,
        related_name='purchases_made'
    )
    seller = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.PROTECT,
        related_name='sales_made'
    )
    
    # Prodotto
    item = models.ForeignKey(
        Item,
        on_delete=models.PROTECT,
        related_name='payment_transactions'
    )
    
    # Importi (in centesimi per evitare problemi floating point)
    item_price_cents = models.PositiveIntegerField(help_text="Prezzo dell'annuncio in centesimi")
    platform_fee_cents = models.PositiveIntegerField(default=0, help_text="Commissione piattaforma in centesimi")
    stripe_fee_cents = models.PositiveIntegerField(default=0, help_text="Commissione Stripe in centesimi")
    total_amount_cents = models.PositiveIntegerField(help_text="Importo totale in centesimi")
    
    # Metadati transazione
    currency = models.CharField(max_length=3, default='EUR')
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default=STATUS_PENDING)
    
    # Timestamp
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    # Dati aggiuntivi
    buyer_email = models.EmailField()
    buyer_name = models.CharField(max_length=255, blank=True)
    shipping_address = models.TextField(blank=True, help_text="Indirizzo di spedizione se necessario")
    notes = models.TextField(blank=True, help_text="Note aggiuntive")
    
    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['buyer', 'status']),
            models.Index(fields=['seller', 'status']),
            models.Index(fields=['status', 'created_at']),
            models.Index(fields=['stripe_payment_intent_id']),
        ]
    
    def __str__(self):
        return f"Transazione {self.uuid.hex[:8]} - {self.buyer.username} â†’ {self.seller.username} | {self.item.title} | {self.status}"
    
    def get_absolute_url(self):
        return reverse('payments:transaction_detail', kwargs={'uuid': self.uuid})
    
    # ProprietÃ  per gestire importi in euro
    @property
    def item_price_euros(self):
        return Decimal(self.item_price_cents) / 100
    
    @property
    def platform_fee_euros(self):
        return Decimal(self.platform_fee_cents) / 100
    
    @property
    def stripe_fee_euros(self):
        return Decimal(self.stripe_fee_cents) / 100
    
    @property
    def total_amount_euros(self):
        return Decimal(self.total_amount_cents) / 100
    
    @classmethod
    def calculate_fees(cls, item_price_euros):
        """Calcola le commissioni per un determinato prezzo"""
        item_price_cents = int(item_price_euros * 100)
        
        # Commissione piattaforma: 3% dell'importo
        platform_fee_cents = int(item_price_cents * 0.03)
        
        # Commissione Stripe: 1.4% + â‚¬0.25 per transazione in Europa
        stripe_fee_cents = int(item_price_cents * 0.014) + 25  # 25 centesimi
        
        total_cents = item_price_cents + platform_fee_cents + stripe_fee_cents
        
        return {
            'item_price_cents': item_price_cents,
            'platform_fee_cents': platform_fee_cents,
            'stripe_fee_cents': stripe_fee_cents,
            'total_amount_cents': total_cents,
        }
    
    def mark_as_succeeded(self):
        """Segna la transazione come completata"""
        if self.status != self.STATUS_SUCCEEDED:
            self.status = self.STATUS_SUCCEEDED
            self.completed_at = timezone.now()
            
            # Disattiva l'annuncio (venduto)
            if self.item.is_active:
                self.item.is_active = False
                self.item.save(update_fields=['is_active'])
            
            self.save(update_fields=['status', 'completed_at'])
    
    def mark_as_failed(self):
        """Segna la transazione come fallita"""
        self.status = self.STATUS_FAILED
        self.save(update_fields=['status'])


class SellerProfile(models.Model):
    """Profilo esteso per i venditori"""
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='seller_profile'
    )
    
    # Dati Stripe Connect (per i pagamenti ai venditori)
    stripe_account_id = models.CharField(max_length=255, blank=True, null=True)
    stripe_onboarding_completed = models.BooleanField(default=False)
    
    # Statistiche
    total_sales = models.PositiveIntegerField(default=0)
    total_revenue_cents = models.PositiveIntegerField(default=0)
    average_rating = models.DecimalField(max_digits=3, decimal_places=2, default=0.00)
    
    # Configurazione
    accepts_payments = models.BooleanField(default=True, help_text="Accetta pagamenti per i propri annunci")
    auto_accept_payments = models.BooleanField(default=True, help_text="Accetta automaticamente i pagamenti")
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"Venditore: {self.user.username}"
    
    @property
    def total_revenue_euros(self):
        return Decimal(self.total_revenue_cents) / 100
    
    def update_stats(self):
        """Aggiorna le statistiche del venditore"""
        completed_transactions = PaymentTransaction.objects.filter(
            seller=self.user,
            status=PaymentTransaction.STATUS_SUCCEEDED
        )
        
        self.total_sales = completed_transactions.count()
        self.total_revenue_cents = sum(
            t.item_price_cents for t in completed_transactions
        )
        
        # TODO: Implementare sistema di rating per gli acquisti
        # Per ora manteniamo il rating del sistema di scambi se presente
        if hasattr(self.user, 'trade_profile'):
            self.average_rating = self.user.trade_profile.average_rating
        
        self.save(update_fields=['total_sales', 'total_revenue_cents', 'average_rating'])


class PurchaseRequest(models.Model):
    """Richiesta di acquisto - step intermedio prima del pagamento"""
    
    STATUS_PENDING = 'pending'
    STATUS_APPROVED = 'approved'
    STATUS_REJECTED = 'rejected'
    STATUS_EXPIRED = 'expired'
    STATUS_COMPLETED = 'completed'  # Collegato a una transazione completata
    
    STATUS_CHOICES = [
        (STATUS_PENDING, 'In Attesa'),
        (STATUS_APPROVED, 'Approvata'),
        (STATUS_REJECTED, 'Rifiutata'),
        (STATUS_EXPIRED, 'Scaduta'),
        (STATUS_COMPLETED, 'Completata'),
    ]
    
    uuid = models.UUIDField(default=uuid.uuid4, unique=True, editable=False)
    
    buyer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='purchase_requests_made'
    )
    seller = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='purchase_requests_received'
    )
    item = models.ForeignKey(
        Item,
        on_delete=models.CASCADE,
        related_name='purchase_requests'
    )
    
    # Messaggio dell'acquirente
    message = models.TextField(
        blank=True,
        help_text="Messaggio opzionale per il venditore"
    )
    
    # Dettagli di spedizione/ritiro
    delivery_method = models.CharField(
        max_length=50,
        choices=[
            ('pickup', 'Ritiro di persona'),
            ('shipping', 'Spedizione'),
            ('both', 'Entrambi disponibili'),
        ],
        default='both'
    )
    shipping_address = models.TextField(blank=True)
    
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default=STATUS_PENDING)
    
    # Collegamenti
    payment_transaction = models.OneToOneField(
        PaymentTransaction,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='purchase_request'
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    expires_at = models.DateTimeField(help_text="Scadenza automatica della richiesta")
    
    def save(self, *args, **kwargs):
        # Auto-imposta scadenza a 48 ore se non specificata
        if not self.expires_at:
            self.expires_at = timezone.now() + timezone.timedelta(hours=48)
        super().save(*args, **kwargs)
    
    def is_expired(self):
        return timezone.now() > self.expires_at and self.status == self.STATUS_PENDING
    
    def __str__(self):
        return f"Richiesta {self.uuid.hex[:8]} - {self.buyer.username} vuole acquistare {self.item.title}"
```


### payments/signals.py

```python
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth.models import User
from .models import SellerProfile


@receiver(post_save, sender=User)
def create_seller_profile(sender, instance, created, **kwargs):
    """
    Crea automaticamente un profilo venditore per ogni nuovo utente
    """
    if created:
        SellerProfile.objects.create(user=instance)


@receiver(post_save, sender=User)  
def save_seller_profile(sender, instance, **kwargs):
    """
    Salva il profilo venditore quando l'utente viene salvato
    """
    try:
        instance.seller_profile.save()
    except SellerProfile.DoesNotExist:
        SellerProfile.objects.create(user=instance)
```


### payments/views.py

```python
import stripe
from django.conf import settings
from django.contrib import messages
from django.contrib.auth.mixins import LoginRequiredMixin
from django.contrib.auth.decorators import login_required
from django.core.exceptions import PermissionDenied
from django.http import HttpResponse, JsonResponse, HttpResponseForbidden
from django.shortcuts import get_object_or_404, redirect, render
from django.urls import reverse
from django.utils.decorators import method_decorator
from django.views import View
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_POST
from django.views.generic import ListView, DetailView
import json
import logging

from django_classified.models import Item
from .models import PaymentTransaction, SellerProfile, PurchaseRequest
from .forms import PurchaseRequestForm, SellerOnboardingForm

# Configura Stripe
stripe.api_key = settings.STRIPE_SECRET_KEY

logger = logging.getLogger(__name__)


class SellerRequestsView(LoginRequiredMixin, ListView):
    """Lista delle richieste di acquisto ricevute dal venditore"""
    model = PurchaseRequest
    template_name = 'payments/seller_requests.html'
    context_object_name = 'requests'
    paginate_by = 20
    
    def get_queryset(self):
        return PurchaseRequest.objects.filter(
            seller=self.request.user
        ).select_related('buyer', 'item').order_by('-created_at')
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['pending_count'] = self.get_queryset().filter(
            status=PurchaseRequest.STATUS_PENDING
        ).count()
        return context


class RequestPurchaseView(LoginRequiredMixin, View):
    """Richiesta di acquisto per un annuncio"""
    template_name = 'payments/request_purchase.html'
    
    def get(self, request, item_id):
        item = get_object_or_404(Item, pk=item_id, is_active=True)
        
        # Non puoi comprare da te stesso
        if item.user == request.user:
            messages.error(request, "Non puoi acquistare i tuoi stessi annunci.")
            return redirect(item.get_absolute_url())
        
        # Verifica che il venditore accetti pagamenti
        seller_profile, _ = SellerProfile.objects.get_or_create(user=item.user)
        if not seller_profile.accepts_payments:
            messages.error(request, "Questo venditore non accetta pagamenti online.")
            return redirect(item.get_absolute_url())
        
        # Controlla se c'Ã¨ giÃ  una richiesta pendente
        existing_request = PurchaseRequest.objects.filter(
            buyer=request.user,
            item=item,
            status=PurchaseRequest.STATUS_PENDING
        ).first()
        
        if existing_request:
            messages.info(request, "Hai giÃ  una richiesta di acquisto pendente per questo annuncio.")
            return redirect('payments:request_detail', uuid=existing_request.uuid)
        
        # Calcola commissioni
        fees = PaymentTransaction.calculate_fees(float(item.price))
        
        form = PurchaseRequestForm(item=item)
        
        context = {
            'item': item,
            'seller_profile': seller_profile,
            'form': form,
            'fees': fees,
            'total_euros': fees['total_amount_cents'] / 100,
        }
        
        return render(request, self.template_name, context)
    
    def post(self, request, item_id):
        item = get_object_or_404(Item, pk=item_id, is_active=True)
        
        if item.user == request.user:
            return HttpResponseForbidden()
        
        form = PurchaseRequestForm(item=item, data=request.POST)
        
        if form.is_valid():
            purchase_request = form.save(commit=False)
            purchase_request.buyer = request.user
            purchase_request.seller = item.user
            purchase_request.item = item
            purchase_request.save()
            
            messages.success(
                request,
                f"Richiesta di acquisto inviata a {item.user.username}!"
            )
            return redirect('payments:request_detail', uuid=purchase_request.uuid)
        
        # Errori nel form
        fees = PaymentTransaction.calculate_fees(float(item.price))
        context = {
            'item': item,
            'form': form,
            'fees': fees,
            'total_euros': fees['total_amount_cents'] / 100,
        }
        
        return render(request, self.template_name, context)


class PurchaseRequestDetailView(LoginRequiredMixin, DetailView):
    """Dettaglio richiesta di acquisto"""
    model = PurchaseRequest
    template_name = 'payments/request_detail.html'
    context_object_name = 'purchase_request'
    slug_field = 'uuid'
    slug_url_kwarg = 'uuid'
    
    def get_object(self):
        obj = super().get_object()
        # Solo buyer o seller possono vedere
        if self.request.user not in [obj.buyer, obj.seller]:
            raise PermissionDenied("Non autorizzato")
        return obj
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        request = self.get_object()
        user = self.request.user
        
        # Calcola commissioni in euro (non centesimi)
        fees = PaymentTransaction.calculate_fees(float(request.item.price))
        context['fees'] = {
            'item_price_euros': fees['item_price_cents'] / 100,
            'platform_fee_euros': fees['platform_fee_cents'] / 100,
            'stripe_fee_euros': fees['stripe_fee_cents'] / 100,
            'total_amount_euros': fees['total_amount_cents'] / 100,
        }
        
        # Permessi
        context['is_seller'] = user == request.seller
        context['is_buyer'] = user == request.buyer
        context['can_approve'] = (
            user == request.seller and 
            request.status == PurchaseRequest.STATUS_PENDING and 
            not request.is_expired()
        )
        
        return context


@method_decorator(login_required, name='dispatch')
class ProcessPurchaseRequestView(View):
    """Approva o rifiuta una richiesta di acquisto"""
    
    def post(self, request, uuid, action):
        purchase_request = get_object_or_404(PurchaseRequest, uuid=uuid)
        
        # Solo il venditore puÃ² approvare/rifiutare
        if request.user != purchase_request.seller:
            return HttpResponseForbidden()
        
        if action == 'approve':
            if purchase_request.status == PurchaseRequest.STATUS_PENDING:
                purchase_request.status = PurchaseRequest.STATUS_APPROVED
                purchase_request.save()
                messages.success(request, "Richiesta approvata! Ora l'acquirente puÃ² procedere al pagamento.")
            else:
                messages.error(request, "Questa richiesta non puÃ² essere approvata.")
                
        elif action == 'reject':
            if purchase_request.status == PurchaseRequest.STATUS_PENDING:
                purchase_request.status = PurchaseRequest.STATUS_REJECTED
                purchase_request.save()
                messages.info(request, "Richiesta rifiutata.")
            else:
                messages.error(request, "Questa richiesta non puÃ² essere rifiutata.")
        
        return redirect('payments:request_detail', uuid=uuid)


class CreateCheckoutSessionView(LoginRequiredMixin, View):
    """Crea una sessione Stripe Checkout"""
    
    def post(self, request, uuid):
        purchase_request = get_object_or_404(PurchaseRequest, uuid=uuid)
        
        # Solo il buyer puÃ² procedere al pagamento
        if request.user != purchase_request.buyer:
            return HttpResponseForbidden()
        
        # La richiesta deve essere approvata
        if purchase_request.status != PurchaseRequest.STATUS_APPROVED:
            messages.error(request, "La richiesta deve essere approvata dal venditore prima di procedere al pagamento.")
            return redirect('payments:request_detail', uuid=uuid)
        
        # Verifica che l'annuncio sia ancora disponibile
        if not purchase_request.item.is_active:
            messages.error(request, "Questo annuncio non Ã¨ piÃ¹ disponibile.")
            return redirect('payments:request_detail', uuid=uuid)
        
        try:
            # Calcola importi
            fees = PaymentTransaction.calculate_fees(float(purchase_request.item.price))
            
            # Crea la transazione nel database
            transaction = PaymentTransaction.objects.create(
                buyer=request.user,
                seller=purchase_request.seller,
                item=purchase_request.item,
                buyer_email=request.user.email,
                buyer_name=request.user.get_full_name() or request.user.username,
                shipping_address=purchase_request.shipping_address,
                **fees
            )
            
            # Collega la transazione alla richiesta
            purchase_request.payment_transaction = transaction
            purchase_request.save()
            
            # Crea sessione Stripe Checkout
            checkout_session = stripe.checkout.Session.create(
                payment_method_types=['card'],
                line_items=[{
                    'price_data': {
                        'currency': 'eur',
                        'product_data': {
                            'name': f"{purchase_request.item.title}",
                            'description': f"Acquisto da {purchase_request.seller.username} su NINVENDO",
                        },
                        'unit_amount': fees['total_amount_cents'],
                    },
                    'quantity': 1,
                }],
                mode='payment',
                success_url=request.build_absolute_uri(
                    reverse('payments:payment_success', kwargs={'uuid': transaction.uuid})
                ),
                cancel_url=request.build_absolute_uri(
                    reverse('payments:payment_cancelled', kwargs={'uuid': transaction.uuid})
                ),
                metadata={
                    'transaction_uuid': str(transaction.uuid),
                    'buyer_id': str(request.user.id),
                    'seller_id': str(purchase_request.seller.id),
                    'item_id': str(purchase_request.item.id),
                }
            )
            
            # Salva l'ID della sessione
            transaction.stripe_checkout_session_id = checkout_session.id
            transaction.status = PaymentTransaction.STATUS_PROCESSING
            transaction.save()
            
            # Redirect a Stripe Checkout
            return redirect(checkout_session.url)
            
        except Exception as e:
            logger.error(f"Errore creazione sessione Stripe: {e}")
            messages.error(request, "Si Ã¨ verificato un errore durante la creazione del pagamento.")
            return redirect('payments:request_detail', uuid=uuid)


class PaymentTransactionDetailView(LoginRequiredMixin, DetailView):
    """Dettaglio di una transazione di pagamento"""
    model = PaymentTransaction
    template_name = 'payments/transaction_detail.html'
    context_object_name = 'transaction'
    slug_field = 'uuid'
    slug_url_kwarg = 'uuid'
    
    def get_object(self):
        obj = super().get_object()
        # Solo buyer o seller possono vedere
        if self.request.user not in [obj.buyer, obj.seller]:
            raise PermissionDenied("Non autorizzato")
        return obj
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        transaction = self.get_object()
        
        # Aggiungi info sulla richiesta collegata
        try:
            context['purchase_request'] = transaction.purchase_request
        except:

<<TRUNCATED: showing first 300 lines>>
```


### trade/admin.py

```python
from django.contrib import admin

# Register your models here.
from django.contrib import admin
from .models import TradeProposal, TradeFeedback

# Aggiungi questo al file trade/admin.py

from .user_profile import UserProfile

@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ('user', 'phone_number', 'show_phone_in_trades', 'location', 'created_at')
    list_filter = ('show_phone_in_trades', 'created_at')
    search_fields = ('user__username', 'phone_number', 'location')
    readonly_fields = ('created_at', 'updated_at')

@admin.register(TradeProposal)
class TradeProposalAdmin(admin.ModelAdmin):
    list_display = ("id", "from_user", "to_user", "offer_item", "want_item", "state", "created_at")
    list_filter = ("state",)
    search_fields = ("from_user__username", "to_user__username")

@admin.register(TradeFeedback)
class TradeFeedbackAdmin(admin.ModelAdmin):
    list_display = ("id", "trade", "rater", "ratee", "rating", "created_at")
    list_filter = ("rating",)
```


### trade/apps.py

```python
from django.apps import AppConfig


class TradeConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'trade'
```


### trade/forms.py

```python
from django import forms
from django.contrib.auth import get_user_model
from django.core.exceptions import ValidationError
from crispy_forms.helper import FormHelper
from crispy_forms.layout import Layout, Submit, HTML, Row, Column, Div, Field
from crispy_forms.bootstrap import InlineRadios

from django_classified.models import Item
from .models import TradeProposal, TradeFeedback, UserTradeProfile, TradeMessage

User = get_user_model()


# ------------------------------------------------------------
# Profilo Utente Esteso (usando UserTradeProfile invece di UserProfile)
# ------------------------------------------------------------
class UserProfileForm(forms.ModelForm):
    """Form per modificare le informazioni del profilo utente esteso"""
    
    class Meta:
        model = UserTradeProfile
        fields = ['phone_number', 'show_phone_in_trades', 'location', 'bio']
        widgets = {
            'phone_number': forms.TextInput(attrs={
                'placeholder': '+39 123 456 7890',
                'class': 'form-control'
            }),
            'location': forms.TextInput(attrs={
                'placeholder': 'es. Milano, Roma, Napoli...',
                'class': 'form-control'
            }),
            'bio': forms.Textarea(attrs={
                'rows': 3,
                'placeholder': 'Racconta qualcosa di te...',
                'class': 'form-control'
            }),
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        # Labels personalizzate
        self.fields['phone_number'].label = 'Numero di Telefono'
        self.fields['show_phone_in_trades'].label = 'Mostra negli scambi accettati'
        self.fields['location'].label = 'CittÃ /Zona'
        self.fields['bio'].label = 'Biografia'
        
        # Crispy layout se disponibile
        try:
            self.helper = FormHelper()
            self.helper.form_method = "post"
            self.helper.layout = Layout(
                HTML('<h4>ğŸ“ Informazioni di Contatto</h4>'),
                Field('phone_number', placeholder='+39 123 456 7890'),
                Field('show_phone_in_trades'),
                HTML('<small class="form-text text-muted">Il tuo numero sarÃ  visibile solo negli scambi accettati</small>'),
                HTML('<hr>'),
                HTML('<h4>ğŸ“ Localizzazione</h4>'),
                Field('location'),
                HTML('<hr>'),
                HTML('<h4>ğŸ‘¤ Biografia</h4>'),
                Field('bio'),
                HTML('<hr>'),
                Div(
                    Submit('save', 'ğŸ’¾ Salva Profilo', css_class='btn btn-primary btn-block'),
                    css_class='text-center'
                )
            )
        except ImportError:
            # Se crispy_forms non Ã¨ disponibile, usa un form semplice
            pass


# ------------------------------------------------------------
# Messaggistica interna per gli scambi
# ------------------------------------------------------------
class TradeMessageForm(forms.ModelForm):
    """
    Form per inviare un messaggio interno in un Trade con supporto immagini.
    Firma: TradeMessageForm(trade, sender, data=None, files=None, **kwargs)
    """
    class Meta:
        model = TradeMessage
        fields = ["message", "image"]
        widgets = {
            "message": forms.Textarea(attrs={
                "rows": 3,
                "placeholder": "Scrivi un messaggio per organizzare lo scambio...",
                "class": "form-control"
            }),
            "image": forms.ClearableFileInput(attrs={
                "class": "form-control-file",
                "accept": "image/*"
            })
        }

    def __init__(self, trade, sender, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.trade = trade
        self.sender = sender
        
        # Labels personalizzate
        self.fields['message'].label = 'Messaggio'
        self.fields['message'].required = False  # Non obbligatorio se c'Ã¨ un'immagine
        self.fields['image'].label = 'Allega Immagine'
        
        # Help text
        self.fields['image'].help_text = 'Formati supportati: JPG, PNG, GIF (max 5MB)'

        # Crispy layout con supporto immagini
        try:
            self.helper = FormHelper()
            self.helper.form_method = "post"
            self.helper.form_enctype = "multipart/form-data"  # Importante per i file
            self.helper.layout = Layout(
                Field("message", placeholder="Scrivi un messaggio..."),
                HTML('<div class="form-group">'),
                HTML('<label for="id_image">ğŸ“· Allega Immagine (opzionale)</label>'),
                Field("image"),
                HTML('<small class="form-text text-muted">Formati: JPG, PNG, GIF - Max 5MB</small>'),
                HTML('</div>'),
                HTML('<hr>'),
                Submit("send", "ğŸ“¨ Invia Messaggio", css_class="btn btn-info btn-block")
            )
        except ImportError:
            pass
    
    def clean(self):
        """Validazione personalizzata: deve esserci messaggio O immagine"""
        cleaned_data = super().clean()
        message = cleaned_data.get('message', '').strip()
        image = cleaned_data.get('image')
        
        if not message and not image:
            raise ValidationError(
                "Ãˆ necessario scrivere un messaggio o allegare un'immagine."
            )
        
        return cleaned_data
    
    def clean_image(self):
        """Validazione dell'immagine"""
        image = self.cleaned_data.get('image')
        
        if image:
            # Controllo dimensione file (5MB max)
            if image.size > 5 * 1024 * 1024:
                raise ValidationError("L'immagine Ã¨ troppo grande. Dimensione massima: 5MB")
            
            # Controllo tipo file
            if not image.content_type.startswith('image/'):
                raise ValidationError("Il file deve essere un'immagine (JPG, PNG, GIF)")
            
            # Lista formati supportati
            allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
            if image.content_type not in allowed_types:
                raise ValidationError("Formato non supportato. Usa JPG, PNG, GIF o WebP")
        
        return image

    def save(self, commit=True):
        obj = super().save(commit=False)
        obj.trade = self.trade
        obj.sender = self.sender
        # Destinatario = l'altro partecipante allo scambio
        obj.recipient = self.trade.to_user if self.sender == self.trade.from_user else self.trade.from_user
        
        if commit:
            obj.save()
        return obj
    
    
# ------------------------------------------------------------
# Creazione proposta di scambio
# ------------------------------------------------------------
class TradeProposalForm(forms.ModelForm):
    """Form per creare una proposta di scambio"""

    class Meta:
        model = TradeProposal
        fields = ["offer_item", "message"]
        widgets = {
            "message": forms.Textarea(attrs={
                "rows": 4,
                "placeholder": "Scrivi un messaggio opzionale per la tua proposta...",
                "class": "form-control"
            }),
        }

    def __init__(self, user, target_item, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.user = user
        self.target_item = target_item

        # Solo annunci attivi dell'utente corrente, escluso quello target
        self.fields["offer_item"].queryset = Item.objects.filter(
            user=user,
            is_active=True
        ).exclude(pk=target_item.pk)

        self.fields["offer_item"].empty_label = "Seleziona il tuo annuncio da offrire..."

        # Avviso se l'utente non ha annunci attivi
        if not self.fields["offer_item"].queryset.exists():
            self.fields["offer_item"].help_text = """
            <div class="alert alert-warning">
                Non hai annunci attivi da offrire.
                <a href="/item/new/" class="alert-link">Pubblica un annuncio</a> prima di proporre scambi.
            </div>
            """

        # Crispy layout
        try:
            self.helper = FormHelper()
            self.helper.form_method = "post"
            self.helper.layout = Layout(
                HTML(f"""
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-exchange-alt"></i> Proponi Scambio</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Annuncio richiesto:</strong> {self.target_item.title}</p>
                            <p class="text-muted">Proprietario: {self.target_item.user.username}</p>
                        </div>
                    </div>
                """),
                Field("offer_item", css_class="form-control form-control-lg"),
                Field("message"),
                HTML("<hr>"),
                Div(
                    Submit("submit", "ğŸ“¤ Invia Proposta", css_class="btn btn-success btn-lg btn-block"),
                    HTML('<a href="{{ want_item.get_absolute_url }}" class="btn btn-secondary btn-block">âŒ Annulla</a>'),
                    css_class="text-center"
                )
            )
        except ImportError:
            pass

    def clean_offer_item(self):
        offer_item = self.cleaned_data.get("offer_item")
        if not offer_item:
            raise ValidationError("Devi selezionare un annuncio da offrire.")

        if offer_item.user != self.user:
            raise ValidationError("Puoi offrire solo i tuoi annunci.")

        if offer_item == self.target_item:
            raise ValidationError("Non puoi offrire lo stesso annuncio che stai richiedendo.")

        # Evita proposte duplicate pendenti
        existing = TradeProposal.objects.filter(
            from_user=self.user,
            to_user=self.target_item.user,
            offer_item=offer_item,
            want_item=self.target_item,
            state=TradeProposal.STATE_SENT
        ).exists()
        if existing:
            raise ValidationError("Hai giÃ  una proposta pendente per questo scambio.")

        return offer_item


# ------------------------------------------------------------
# Risposta alla proposta (accetta / rifiuta / controproposta)
# ------------------------------------------------------------
class TradeResponseForm(forms.Form):
    """Form per rispondere a una proposta (accetta/rifiuta con messaggio)"""

    ACTION_ACCEPT = "accept"
    ACTION_DECLINE = "decline"
    ACTION_COUNTER = "counter"

    ACTION_CHOICES = [
        (ACTION_ACCEPT, "âœ… Accetta"),
        (ACTION_DECLINE, "âŒ Rifiuta"),
        (ACTION_COUNTER, "ğŸ”„ Fai Controproposta"),
    ]

    action = forms.ChoiceField(
        choices=ACTION_CHOICES,
        widget=forms.RadioSelect,
        label="Come vuoi rispondere?"
    )

    response_message = forms.CharField(
        widget=forms.Textarea(attrs={"rows": 3, "placeholder": "Messaggio opzionale..."}),
        required=False,
        label="Messaggio di risposta"
    )

    # Solo per controposte
    counter_offer_item = forms.ModelChoiceField(
        queryset=Item.objects.none(),
        required=False,
        empty_label="Seleziona un altro tuo annuncio...",
        label="Il tuo annuncio alternativo"
    )


<<TRUNCATED: showing first 300 lines>>
```


### trade/models.py

```python
from django.conf import settings
from django.db import models
from django.urls import reverse
from django.utils import timezone
from datetime import timedelta
from django_fsm import FSMField
from django.core.exceptions import ValidationError

# Logging per tracciare azioni
import logging
logger = logging.getLogger(__name__)

# NB: il modello degli annunci del pacchetto django_classified si chiama "Item"
from django_classified.models import Item


class TradeProposal(models.Model):
    STATE_SENT = "sent"
    STATE_ACCEPTED = "accepted"
    STATE_DECLINED = "declined"
    STATE_CANCELLED = "cancelled"
    STATE_COMPLETED = "completed"

    STATE_CHOICES = [
        (STATE_SENT, "Inviata"),
        (STATE_ACCEPTED, "Accettata"),
        (STATE_DECLINED, "Rifiutata"),
        (STATE_CANCELLED, "Annullata"),
        (STATE_COMPLETED, "Completata"),
    ]

    from_user = models.ForeignKey(
        settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="proposals_sent"
    )
    to_user = models.ForeignKey(
        settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="proposals_received"
    )

    offer_item = models.ForeignKey(
        Item, on_delete=models.PROTECT, related_name="trade_offers"
    )  # annuncio dell'offerente
    want_item = models.ForeignKey(
        Item, on_delete=models.PROTECT, related_name="trade_targets"
    )  # annuncio del destinatario

    message = models.TextField(blank=True, help_text="Messaggio opzionale per la proposta")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # NUOVI CAMPI
    expires_at = models.DateTimeField(null=True, blank=True, help_text="Scadenza automatica proposta")
    is_counter_offer = models.BooleanField(default=False)
    parent_proposal = models.ForeignKey('self', null=True, blank=True, on_delete=models.CASCADE)

    # USIAMO CharField INVECE DI FSMField
    state = models.CharField(max_length=20, choices=STATE_CHOICES, default=STATE_SENT)

    class Meta:
        constraints = [
            # Non puoi proporre uno scambio a te stesso
            models.CheckConstraint(
                check=~models.Q(from_user=models.F("to_user")), name="tp_users_distinct"
            ),
            # Non puoi scambiare lo stesso annuncio con se stesso
            models.CheckConstraint(
                check=~models.Q(offer_item=models.F("want_item")), name="tp_items_distinct"
            ),
        ]
        indexes = [
            models.Index(fields=["to_user", "state"]),
            models.Index(fields=["from_user", "state"]),
            models.Index(fields=["created_at"]),
            models.Index(fields=["expires_at"]),
        ]
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.from_user} â†’ {self.to_user} | {self.offer_item.title} â†” {self.want_item.title} [{self.get_state_display()}]"

    def save(self, *args, **kwargs):
        # Auto-imposta scadenza a 7 giorni se non specificata
        if not self.expires_at and self.state == self.STATE_SENT:
            self.expires_at = timezone.now() + timedelta(days=7)
        super().save(*args, **kwargs)

    def cancel_competing_proposals(self):
        """
        Quando una proposta viene accettata, annulla automaticamente 
        tutte le altre proposte pendenti per gli stessi annunci
        """
        print(f"ğŸ”¥ CANCEL_COMPETING: Cercando proposte concorrenti per Trade {self.id}")
        
        # Trova proposte concorrenti per l'annuncio offerto
        competing_for_offer = list(TradeProposal.objects.filter(
            want_item=self.offer_item,
            state=self.STATE_SENT
        ).exclude(pk=self.pk))
        
        # Trova proposte concorrenti per l'annuncio richiesto
        competing_for_want = list(TradeProposal.objects.filter(
            want_item=self.want_item,
            state=self.STATE_SENT
        ).exclude(pk=self.pk))
        
        # Combina le liste (invece di union)
        all_competing = competing_for_offer + competing_for_want
        # Rimuovi duplicati se ce ne sono
        seen_ids = set()
        unique_competing = []
        for proposal in all_competing:
            if proposal.id not in seen_ids:
                unique_competing.append(proposal)
                seen_ids.add(proposal.id)
        
        print(f"ğŸ”¥ CANCEL_COMPETING: Trovate {len(unique_competing)} proposte da annullare")
        
        for proposal in unique_competing:
            proposal.state = self.STATE_CANCELLED
            proposal.save(update_fields=['state'])
            logger.info(f"Trade {proposal.id}: Automaticamente annullata per conflitto con Trade {self.id}")
            print(f"ğŸ”¥ CANCEL_COMPETING: Annullata proposta {proposal.id}")

    def get_absolute_url(self):
        return reverse('trade:detail', kwargs={'pk': self.pk})
    
    def is_expired(self):
        """Controlla se la proposta Ã¨ scaduta"""
        if not self.expires_at:
            return False
        return timezone.now() > self.expires_at and self.state == self.STATE_SENT
    
    def can_user_act(self, user):
        """Verifica se l'utente puÃ² agire su questa proposta"""
        return user in [self.from_user, self.to_user]
    
    def can_accept(self, user):
        """Solo il destinatario puÃ² accettare"""
        return user == self.to_user and self.state == self.STATE_SENT and not self.is_expired()
    
    def can_decline(self, user):
        """Solo il destinatario puÃ² rifiutare"""
        return user == self.to_user and self.state == self.STATE_SENT
    
    def can_cancel(self, user):
        """Entrambi possono annullare"""
        return user in [self.from_user, self.to_user] and self.state in [self.STATE_SENT, self.STATE_ACCEPTED]
    
    def can_complete(self, user):
        """Entrambi possono completare se accettata"""
        return user in [self.from_user, self.to_user] and self.state == self.STATE_ACCEPTED

    # METODI MANUALI (NON PIÃ™ FSM) CON LOGICA COMPLETA
    def accept(self):
        """Accetta la proposta e disattiva gli annunci"""
        print(f"ğŸ”¥ğŸ”¥ğŸ”¥ ACCEPT MANUALE CHIAMATO! Trade {self.id} ğŸ”¥ğŸ”¥ğŸ”¥")
        
        # Verifica stato
        if self.state != self.STATE_SENT:
            raise ValidationError(f"Non puoi accettare una proposta in stato '{self.state}'")
        
        try:
            # Log dell'azione
            logger.info(f"Trade {self.id}: {self.to_user} ha accettato proposta da {self.from_user}")
            print(f"ğŸ”¥ Log scritto per Trade {self.id}")
            
            # Refresh degli oggetti dal database per sicurezza
            self.offer_item.refresh_from_db()
            self.want_item.refresh_from_db()
            
            print(f"ğŸ”¥ PRIMA della modifica:")
            print(f"   - offer_item({self.offer_item.id}).is_active = {self.offer_item.is_active}")
            print(f"   - want_item({self.want_item.id}).is_active = {self.want_item.is_active}")
            
            # CAMBIA STATO PRIMA DI TUTTO
            self.state = self.STATE_ACCEPTED
            print(f"ğŸ”¥ Stato cambiato in: {self.state}")
            
            # DISATTIVA GLI ANNUNCI COINVOLTI (RISERVATI)
            self.offer_item.is_active = False
            self.offer_item.save(update_fields=['is_active'])
            print(f"ğŸ”¥ offer_item disattivato")
            
            self.want_item.is_active = False  
            self.want_item.save(update_fields=['is_active'])
            print(f"ğŸ”¥ want_item disattivato")
            
            # Verifica che le modifiche siano state applicate
            self.offer_item.refresh_from_db()
            self.want_item.refresh_from_db()
            
            print(f"ğŸ”¥ DOPO la modifica (refresh dal DB):")
            print(f"   - offer_item({self.offer_item.id}).is_active = {self.offer_item.is_active}")
            print(f"   - want_item({self.want_item.id}).is_active = {self.want_item.is_active}")
            
            # ANNULLA PROPOSTE CONCORRENTI
            self.cancel_competing_proposals()
            
            logger.info(f"Trade {self.id}: Annunci {self.offer_item.id} e {self.want_item.id} disattivati (riservati)")
            print(f"ğŸ”¥ ACCEPT completato con successo per Trade {self.id}")
            
        except Exception as e:
            print(f"ğŸ”¥ğŸ”¥ğŸ”¥ ERRORE CRITICO in accept(): {e} ğŸ”¥ğŸ”¥ğŸ”¥")
            print(f"ğŸ”¥ Tipo errore: {type(e).__name__}")
            import traceback
            print(f"ğŸ”¥ Traceback: {traceback.format_exc()}")
            logger.error(f"ERRORE in Trade.accept(): {e}")
            raise

    def decline(self):
        """Rifiuta la proposta"""
        print(f"ğŸ”¥ DECLINE chiamato per Trade {self.id}")
        
        if self.state != self.STATE_SENT:
            raise ValidationError(f"Non puoi rifiutare una proposta in stato '{self.state}'")
        
        self.state = self.STATE_DECLINED
        logger.info(f"Trade {self.id}: {self.to_user} ha rifiutato proposta da {self.from_user}")
        print(f"ğŸ”¥ DECLINE completato per Trade {self.id}")

    def cancel(self):
        """Annulla la proposta"""
        print(f"ğŸ”¥ CANCEL chiamato per Trade {self.id}, stato attuale: {self.state}")
        
        if self.state not in [self.STATE_SENT, self.STATE_ACCEPTED]:
            raise ValidationError(f"Non puoi annullare una proposta in stato '{self.state}'")
        
        try:
            old_state = self.state
            self.state = self.STATE_CANCELLED
            
            # RIATTIVA GLI ANNUNCI SE ERANO STATI DISATTIVATI
            if old_state == self.STATE_ACCEPTED:
                print(f"ğŸ”¥ Stato era ACCEPTED, riattivando annunci")
                
                self.offer_item.refresh_from_db()
                self.want_item.refresh_from_db()
                
                print(f"ğŸ”¥ PRIMA del cancel (is_active): offer={self.offer_item.is_active}, want={self.want_item.is_active}")
                
                # Solo se erano stati disattivati per questo scambio
                self.offer_item.is_active = True
                self.offer_item.save(update_fields=['is_active'])
                
                self.want_item.is_active = True
                self.want_item.save(update_fields=['is_active'])
                
                self.offer_item.refresh_from_db()
                self.want_item.refresh_from_db()
                
                print(f"ğŸ”¥ DOPO il cancel (is_active): offer={self.offer_item.is_active}, want={self.want_item.is_active}")
                
                logger.info(f"Trade {self.id}: Annunci {self.offer_item.id} e {self.want_item.id} riattivati")
            else:
                print(f"ğŸ”¥ Stato non era ACCEPTED, annunci non riattivati")
                
            logger.info(f"Trade {self.id}: Proposta annullata")
                
        except Exception as e:
            print(f"ğŸ”¥ğŸ”¥ğŸ”¥ ERRORE in cancel(): {e} ğŸ”¥ğŸ”¥ğŸ”¥")
            logger.error(f"ERRORE in Trade.cancel(): {e}")
            raise

    def complete(self):
        """Completa lo scambio"""
        print(f"ğŸ”¥ COMPLETE chiamato per Trade {self.id}")
        
        if self.state != self.STATE_ACCEPTED:
            raise ValidationError(f"Non puoi completare una proposta in stato '{self.state}'")
        
        self.state = self.STATE_COMPLETED
        logger.info(f"Trade {self.id}: Scambio completato tra {self.from_user} e {self.to_user}")
        
        # GLI ANNUNCI RIMANGONO DISATTIVATI (SCAMBIATI DEFINITIVAMENTE)
        print(f"ğŸ”¥ Annunci rimangono disattivati (scambio completato)")
        
        # Aggiorna statistiche utenti
        try:
            self.from_user.trade_profile.update_stats()
            self.to_user.trade_profile.update_stats()
            print(f"ğŸ”¥ Statistiche aggiornate per entrambi gli utenti")
        except UserTradeProfile.DoesNotExist:
            print(f"ğŸ”¥ UserTradeProfile non esiste, saltando aggiornamento statistiche")
            pass
        
        print(f"ğŸ”¥ COMPLETE completato per Trade {self.id}")


class TradeMessage(models.Model):
    """Sistema di messaggistica interna per gli scambi CON supporto immagini"""
    trade = models.ForeignKey(TradeProposal, on_delete=models.CASCADE, related_name="messages")
    sender = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="sent_trade_messages")
    recipient = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name="received_trade_messages")
    
    message = models.TextField(
        max_length=1000, 
        blank=True,  # Ora puÃ² essere vuoto se c'Ã¨ un'immagine
        help_text="Messaggio per organizzare lo scambio"
    )
    
    # Campo per l'immagine allegata

<<TRUNCATED: showing first 300 lines>>
```


### trade/views.py

```python
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.mixins import LoginRequiredMixin
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import HttpResponseForbidden
from django.views.generic import ListView, DetailView, View
from django.db.models import Q
from django.utils.decorators import method_decorator
from django.core.exceptions import PermissionDenied

from django_classified.models import Item
from .models import TradeProposal, TradeFeedback, UserTradeProfile, TradeMessage
from .forms import (
    TradeProposalForm,
    TradeResponseForm,
    TradeFeedbackForm,
    TradeMessageForm,
    UserProfileForm,  # Aggiungiamo anche questo import
)

# ğŸ”¥ Import del nuovo modello UserProfile
from .user_profile import UserProfile


def _get_user_phone(u):
    """
    Cerca un numero di telefono in attributi/profili comuni.
    """
    candidates = [
        getattr(u, "phone", None),
        getattr(getattr(u, "profile", None), "phone", None),
        getattr(getattr(u, "userprofile", None), "phone", None),
        getattr(getattr(u, "django_classified_profile", None), "phone", None),
        getattr(getattr(u, "trade_profile", None), "phone", None),
        # ğŸ”¥ Aggiungiamo il nuovo related_name
        getattr(getattr(u, "trade_profile_extended", None), "phone_number", None),
    ]
    for v in candidates:
        if v:
            return v
    return None


class InboxTradesView(LoginRequiredMixin, ListView):
    """Lista scambi ricevuti (inbox)"""
    template_name = "trade/inbox.html"
    context_object_name = "trades"
    paginate_by = 10

    def get_queryset(self):
        return (
            TradeProposal.objects.filter(to_user=self.request.user)
            .select_related("from_user", "offer_item", "want_item")
            .order_by("-created_at")
        )

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["pending_count"] = self.get_queryset().filter(
            state=TradeProposal.STATE_SENT
        ).count()
        context["view_type"] = "inbox"
        return context


class SentTradesView(LoginRequiredMixin, ListView):
    """Lista scambi inviati"""
    template_name = "trade/sent.html"
    context_object_name = "trades"
    paginate_by = 10

    def get_queryset(self):
        return (
            TradeProposal.objects.filter(from_user=self.request.user)
            .select_related("to_user", "offer_item", "want_item")
            .order_by("-created_at")
        )

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["pending_count"] = self.get_queryset().filter(
            state=TradeProposal.STATE_SENT
        ).count()
        context["view_type"] = "sent"
        return context


class TradeDetailView(LoginRequiredMixin, DetailView):
    """Dettaglio singolo scambio"""
    model = TradeProposal
    template_name = "trade/detail.html"
    context_object_name = "trade"

    def get_object(self):
        trade = super().get_object()
        # Solo utenti coinvolti nello scambio possono visualizzare
        if self.request.user not in [trade.from_user, trade.to_user]:
            raise PermissionDenied("Non autorizzato")
        return trade

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        trade = self.get_object()
        user = self.request.user

        # ğŸ”¥ Assicurati che i profili utente estesi esistano
        from_profile, _ = UserProfile.objects.get_or_create(user=trade.from_user)
        to_profile, _ = UserProfile.objects.get_or_create(user=trade.to_user)

        # Permessi per azioni
        context["can_accept"] = trade.can_accept(user)
        context["can_decline"] = trade.can_decline(user)
        context["can_cancel"] = trade.can_cancel(user)
        context["can_complete"] = trade.can_complete(user)

        # Form risposta (se Ã¨ il destinatario e proposta pendente)
        if user == trade.to_user and trade.state == TradeProposal.STATE_SENT:
            context["response_form"] = TradeResponseForm(user, trade)

        # ğŸ”¥ Messaggistica interna (accettato o completato) per i soli partecipanti
        if trade.state in [TradeProposal.STATE_ACCEPTED, TradeProposal.STATE_COMPLETED] and \
           user in (trade.from_user, trade.to_user):

            # Carica thread in ordine cronologico
            msgs_qs = trade.messages.select_related("sender", "recipient").order_by("created_at")
            context["trade_messages"] = msgs_qs

            # Segna come letti i messaggi ricevuti
            msgs_qs.filter(recipient=user, is_read=False).update(is_read=True)

            # Form per nuovo messaggio
            context["message_form"] = TradeMessageForm(trade, user)

            # Controparte + telefono (se disponibile)
            counterparty = trade.to_user if user == trade.from_user else trade.from_user
            context["counterparty"] = counterparty
            context["counterparty_phone"] = _get_user_phone(counterparty)

        # Feedback (solo quando 'completed')
        if trade.state == TradeProposal.STATE_COMPLETED:
            try:
                context["my_feedback"] = TradeFeedback.objects.get(trade=trade, rater=user)
            except TradeFeedback.DoesNotExist:
                context["feedback_form"] = TradeFeedbackForm(trade, user)

        return context


class ProposeTradeView(LoginRequiredMixin, View):
    """Proponi uno scambio per un annuncio specifico"""
    template_name = "trade/propose.html"

    def get(self, request, item_id):
        want_item = get_object_or_404(Item, pk=item_id, is_active=True)

        # Non puoi scambiare con te stesso
        if want_item.user == request.user:
            messages.error(request, "Non puoi proporre scambi per i tuoi annunci.")
            return redirect(want_item.get_absolute_url())

        # Doppio check: attivo?
        if not want_item.is_active:
            messages.error(request, "Questo annuncio non Ã¨ piÃ¹ disponibile per scambi.")
            return redirect("django_classified:index")

        # Hai giÃ  una proposta pendente per questo annuncio?
        existing_proposal = TradeProposal.objects.filter(
            from_user=request.user, want_item=want_item, state=TradeProposal.STATE_SENT
        ).first()
        if existing_proposal:
            messages.warning(request, "Hai giÃ  una proposta pendente per questo annuncio.")
            return redirect("trade:detail", pk=existing_proposal.pk)

        form = TradeProposalForm(request.user, want_item)

        # Annunci offerta disponibili dell'utente
        available_items = (
            Item.objects.filter(user=request.user, is_active=True)
            .exclude(pk=item_id)
        )

        context = {
            "want_item": want_item,
            "form": form,
            "available_items": available_items,
            "has_items": available_items.exists(),
        }
        return render(request, self.template_name, context)

    def post(self, request, item_id):
        want_item = get_object_or_404(Item, pk=item_id, is_active=True)

        if want_item.user == request.user:
            return HttpResponseForbidden()

        if not want_item.is_active:
            messages.error(request, "Questo annuncio non Ã¨ piÃ¹ disponibile.")
            return redirect("django_classified:index")

        form = TradeProposalForm(request.user, want_item, request.POST)

        if form.is_valid():
            offer_item = form.cleaned_data["offer_item"]

            if not offer_item.is_active:
                messages.error(request, "L'annuncio che vuoi offrire non Ã¨ piÃ¹ disponibile.")
                return redirect("trade:sent")

            proposal = form.save(commit=False)
            proposal.from_user = request.user
            proposal.to_user = want_item.user
            proposal.want_item = want_item
            proposal.save()

            messages.success(request, f"Proposta inviata a {want_item.user.username}!")
            return redirect("trade:sent")

        context = {"want_item": want_item, "form": form}
        return render(request, self.template_name, context)


class TradeActionView(LoginRequiredMixin, View):
    """Azioni su scambi (accept/decline/cancel/complete)"""

    def post(self, request, pk, action):
        print("ğŸ”¥ğŸ”¥ğŸ”¥ TRADEACTIONVIEW CHIAMATA ğŸ”¥ğŸ”¥ğŸ”¥")
        print(f"ğŸ”¥ pk={pk}, action={action}, user={request.user}")

        trade = get_object_or_404(TradeProposal, pk=pk)
        user = request.user

        print(f"ğŸ”¥ Trade trovato: {trade}")
        print(f"ğŸ”¥ Trade.state attuale: {trade.state}")
        print(f"ğŸ”¥ Trade.from_user: {trade.from_user}")
        print(f"ğŸ”¥ Trade.to_user: {trade.to_user}")

        # Permessi base
        if not trade.can_user_act(user):
            print("ğŸ”¥ ERRORE: Utente non autorizzato ad agire")
            return HttpResponseForbidden("Non autorizzato")

        print(f"ğŸ”¥ Permessi OK, eseguendo azione: {action}")

        try:
            if action == "accept" and trade.can_accept(user):
                print("ğŸ”¥ Condizione ACCEPT soddisfatta")
                trade.accept()
                trade.save()
                messages.success(request, "Proposta accettata!")
                # Dopo l'accettazione porta subito al dettaglio per chattare
                print("ğŸ”¥ Redirect detail (scambio accettato)")
                return redirect("trade:detail", pk=trade.pk)

            elif action == "decline" and trade.can_decline(user):
                print("ğŸ”¥ CHIAMANDO trade.decline()")
                trade.decline()
                trade.save()
                messages.info(request, "Proposta rifiutata.")

            elif action == "cancel" and trade.can_cancel(user):
                print("ğŸ”¥ CHIAMANDO trade.cancel()")
                trade.cancel()
                trade.save()
                messages.warning(request, "Proposta annullata.")

            elif action == "complete" and trade.can_complete(user):
                print("ğŸ”¥ CHIAMANDO trade.complete()")
                trade.complete()
                trade.save()
                messages.success(request, "Scambio completato! Lascia un feedback.")

            else:
                print("ğŸ”¥ NESSUNA CONDIZIONE SODDISFATTA!")
                print(f"ğŸ”¥ action='{action}'")
                print(f"ğŸ”¥ can_accept={trade.can_accept(user)}")
                print(f"ğŸ”¥ can_decline={trade.can_decline(user)}")
                print(f"ğŸ”¥ can_cancel={trade.can_cancel(user)}")
                print(f"ğŸ”¥ can_complete={trade.can_complete(user)}")
                messages.error(request, "Azione non permessa.")

        except Exception as e:
            print(f"ğŸ”¥ğŸ”¥ğŸ”¥ ERRORE NELLA VIEW: {e} ğŸ”¥ğŸ”¥ğŸ”¥")
            import traceback
            print(f"ğŸ”¥ Traceback completo: {traceback.format_exc()}")
            messages.error(request, f"Errore: {str(e)}")

        # Redirect "di comodo"
        if user == trade.to_user:
            print("ğŸ”¥ Redirect inbox")
            return redirect("trade:inbox")
        else:
            print("ğŸ”¥ Redirect sent")
            return redirect("trade:sent")



# Sostituisci la classe SendTradeMessageView esistente in trade/views.py

@method_decorator(login_required, name="dispatch")
class SendTradeMessageView(View):

<<TRUNCATED: showing first 300 lines>>
```