{% extends "django_classified/_base.html" %}
{% load i18n %}

{% block title %}Pagamento Completato{% endblock %}

{% block body %}
<div class="container" style="max-width: 800px;">
    <!-- Header Successo -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="alert alert-success text-center">
                <h2 class="mb-3">üéâ Pagamento Completato!</h2>
                <p class="lead mb-0">Il tuo acquisto √® stato elaborato con successo.</p>
            </div>
        </div>
    </div>

    <!-- Dettagli Transazione -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>üìã Dettagli dell'Acquisto</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><strong>Articolo Acquistato:</strong></h6>
                            <p class="text-primary">{{ transaction.item.title }}</p>
                            
                            <h6><strong>Venditore:</strong></h6>
                            <p>{{ transaction.seller.username }}</p>
                            
                            <h6><strong>Data Acquisto:</strong></h6>
                            <p>{{ transaction.created_at|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><strong>ID Transazione:</strong></h6>
                            <p><code>{{ transaction.uuid|slice:":8" }}</code></p>
                            
                            <h6><strong>Importo Pagato:</strong></h6>
                            <p class="text-success"><strong>‚Ç¨{{ transaction.total_amount_euros|floatformat:2 }}</strong></p>
                            
                            <h6><strong>Stato:</strong></h6>
                            <span class="badge badge-success">‚úÖ Completato</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Breakdown Costi -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6>üí∞ Dettaglio Costi</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between">
                                <span>Prezzo articolo:</span>
                                <span>‚Ç¨{{ transaction.item_price_euros|floatformat:2 }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Commissione piattaforma (3%):</span>
                                <span>‚Ç¨{{ transaction.platform_fee_euros|floatformat:2 }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Commissione Stripe:</span>
                                <span>‚Ç¨{{ transaction.stripe_fee_euros|floatformat:2 }}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Totale pagato:</strong>
                                <strong>‚Ç¨{{ transaction.total_amount_euros|floatformat:2 }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informazioni Contatto Venditore -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6>üìû Prossimi Passi</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6>‚úÖ Il tuo pagamento √® stato confermato!</h6>
                        <p>Il venditore <strong>{{ transaction.seller.username }}</strong> √® stato notificato del tuo acquisto.</p>
                    </div>
                    
                    <h6>Come procedere:</h6>
                    <ol>
                        <li><strong>Contatta il venditore</strong> per accordarvi su spedizione o ritiro</li>
                        <li><strong>Email venditore:</strong> {{ transaction.seller.email }}</li>
                        {% if transaction.shipping_address %}
                        <li><strong>Il tuo indirizzo di spedizione:</strong><br>
                            <code>{{ transaction.shipping_address|linebreaks }}</code>
                        </li>
                        {% endif %}
                        <li>Attendi la consegna o organizza il ritiro</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Importante:</strong> Conserva questa pagina come ricevuta del tuo acquisto.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Azioni Disponibili -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6>üîó Azioni Disponibili</h6>
                </div>
                <div class="card-body text-center">
                    <div class="btn-group btn-group-lg">
                        <a href="{% url 'payments:purchase_history' %}" class="btn btn-primary">
                            üìã I Miei Acquisti
                        </a>
                        
                        <a href="{{ transaction.item.get_absolute_url }}" class="btn btn-secondary">
                            üëÅÔ∏è Vedi Annuncio
                        </a>
                        
                        <a href="{% url 'django_classified:index' %}" class="btn btn-success">
                            üè† Torna alla Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supporto -->
    <div class="row">
        <div class="col-md-12">
            <div class="card border-secondary">
                <div class="card-body text-center">
                    <h6>üÜò Hai bisogno di aiuto?</h6>
                    <p class="text-muted">
                        Se hai problemi con questo acquisto o domande,
                        <a href="mailto:support@ninvendo.com">contatta il nostro supporto</a>
                    </p>
                    <p><small>ID Transazione: {{ transaction.uuid }}</small></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-stampa della ricevuta se richiesta
window.onload = function() {
    // Mostra messaggio di successo per 5 secondi
    setTimeout(function() {
        const alert = document.querySelector('.alert-success');
        if (alert) {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0.8';
        }
    }, 5000);
};

// Funzione per stampare la ricevuta
function printReceipt() {
    window.print();
}
</script>

<!-- Print Button (nascosto di default) -->
<div class="d-print-none text-center mb-4">
    <button onclick="printReceipt()" class="btn btn-outline-secondary">
        üñ®Ô∏è Stampa Ricevuta
    </button>
</div>

<!-- Stile per la stampa -->
<style>
@media print {
    .btn, .card-header, .alert-warning {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    .d-print-none {
        display: none !important;
    }
}
</style>
{% endblock %}