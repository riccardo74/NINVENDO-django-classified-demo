{% extends "django_classified/_base.html" %}
{% load humanize %}

{% block title %}I miei acquisti{% endblock %}

{% block body %}
<div class="container" style="max-width: 1100px;">
  <h2 class="mt-3">🛍️ I Miei Acquisti</h2>

  <!-- Stat cards -->
  <div class="row g-3 mt-2">
    <div class="col-6 col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted small">I Miei Acquisti</div>
        <div class="h4 mb-0">{{ total_transactions|default:0 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted small">Richieste Pendenti</div>
        <div class="h4 mb-0">{{ pending_requests_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted small">Richieste Approvate</div>
        <div class="h4 mb-0">{{ approved_requests_count|default:0 }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="text-muted small">Totale Speso</div>
        <div class="h4 mb-0">€{{ total_spent|floatformat:2 }}</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link active" data-toggle="tab" href="#active-requests">
        🔄 Richieste Attive
        {% if active_requests %}
          <span class="badge badge-warning">{{ active_requests|length }}</span>
        {% endif %}
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#completed-purchases">
        ✅ Acquisti Completati
        {% if completed_purchases %}
          <span class="badge badge-info">{{ completed_purchases }}</span>
        {% endif %}
      </a>
    </li>
  </ul>

  <div class="tab-content">

    <!-- Richieste attive -->
    <div class="tab-pane fade show active" id="active-requests">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Articolo</th><th>Venditore</th><th>Prezzo</th><th>Stato</th><th>Creata il</th><th>Scade il</th><th>Azioni</th>
            </tr>
          </thead>
          <tbody>
          {% for r in active_requests %}
            <tr>
              <td>
                {{ r.item.title }}<br>
                {% if r.item.image %}<span class="text-muted">📷 Con immagine</span>{% endif %}
              </td>
              <td>{{ r.seller.username }}</td>
              <td>€{{ r.item.price|floatformat:2 }}</td>
              <td>
                {% if r.status == 'approved' %}✅ Approvata
                {% elif r.status == 'pending' %}⏳ In attesa
                {% else %}{{ r.get_status_display }}{% endif %}
              </td>
              <td>{{ r.created_at|date:"d/m/Y" }}</td>
              <td>{{ r.expires_at|date:"d/m/Y" }}</td>
              <td>
                {% if r.status == 'approved' %}
                  <form method="post" action="{% url 'payments:create_checkout' r.uuid %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-primary">Paga ora</button>
                  </form>
                {% else %}
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'payments:request_detail' r.uuid %}">Dettagli</a>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="text-muted">Nessuna richiesta attiva.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Acquisti completati -->
    <div class="tab-pane fade" id="completed-purchases">
      <div class="table-responsive mt-3">
        <table class="table align-middle">
          <thead>
            <tr><th>Data</th><th>Articolo</th><th>Venditore</th><th>Importo</th><th>Stato</th><th>Azioni</th></tr>
          </thead>
          <tbody>
          {% for t in completed_transactions %}
            <tr>
              <td>{{ t.created_at|date:"d/m/Y H:i" }}</td>
              <td>{{ t.item.title }}<br><small class="text-muted">#{{ t.uuid }}</small></td>
              <td>{{ t.seller.username }}</td>
              <td>€{{ t.total_amount_euros|floatformat:2 }}</td>
              <td>✅ Completato</td>
              <td>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'payments:transaction_detail' t.uuid %}">📋 Dettagli</a>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'payments:payment_success' t.uuid %}">🧾 Ricevuta</a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted">Nessun acquisto completato.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}
